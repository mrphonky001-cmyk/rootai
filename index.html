<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>DarkRoot AI - Ultimate Developer Assistant</title>

<!-- SYSTEM CORE LIBRARIES -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/marked/9.1.2/marked.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/atom-one-dark.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js"></script>

<!-- ACE EDITOR ENGINE -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.32.7/ace.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.32.7/ext-language_tools.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.32.7/mode-html.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.32.7/mode-python.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.32.7/mode-c_cpp.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.32.7/mode-javascript.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.32.7/mode-css.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.32.7/theme-dracula.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.32.7/theme-chrome.js"></script>

<!-- HAMMER JS FOR GESTURES -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/hammer.js/2.0.8/hammer.min.js"></script>

<style>
/* ================= VARIABLES & THEME ENGINE ================= */
:root {
  /* DARKROOT THEME (DEFAULT) */
  --bg-color: #0a0e17;
  --sidebar-bg: rgba(25, 33, 52, 0.85);
  --panel-bg: #1a2236;
  --border-color: rgba(100, 116, 139, 0.2);
  --primary: #8b5cf6;
  --primary-gradient: linear-gradient(135deg, #8b5cf6, #ec4899);
  --cyber-gradient: linear-gradient(90deg, #00d4ff, #8b5cf6, #ec4899);
  --text-primary: #f1f5f9;
  --text-secondary: #94a3b8;
  --history-item-bg: rgba(255, 255, 255, 0.03);
  --history-item-hover: rgba(139, 92, 246, 0.15);
  --input-bg: rgba(255, 255, 255, 0.05);
  --glass-filter: blur(16px);
  --shadow-glow: 0 0 30px rgba(139, 92, 246, 0.25);
  --danger: #ef4444;
  --success: #10b981;
  --warning: #f59e0b;
  --cyber-blue: #00d4ff;
  --hacker-green: #00ff88;
  --deepseek-green: #00d8a7;
}

body.light-mode {
  /* LIGHT MODE */
  --bg-color: #f8fafc;
  --sidebar-bg: rgba(255, 255, 255, 0.95);
  --panel-bg: #ffffff;
  --border-color: #e2e8f0;
  --primary: #7c3aed;
  --primary-gradient: linear-gradient(135deg, #7c3aed, #db2777);
  --cyber-gradient: linear-gradient(90deg, #3b82f6, #8b5cf6, #ec4899);
  --text-primary: #1e293b;
  --text-secondary: #64748b;
  --history-item-bg: #ffffff;
  --history-item-hover: #f1f5f9;
  --input-bg: #ffffff;
  --glass-filter: blur(20px);
  --shadow-glow: 0 4px 25px rgba(124, 58, 237, 0.15);
  --danger: #dc2626;
  --success: #059669;
  --warning: #d97706;
  --cyber-blue: #3b82f6;
  --hacker-green: #059669;
  --deepseek-green: #00b894;
}

* { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

body {
  margin: 0;
  font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
  background-color: var(--bg-color);
  color: var(--text-primary);
  height: 100vh; height: 100dvh; width: 100vw;
  overflow: hidden;
  display: flex; justify-content: center; align-items: center;
  transition: background 0.4s ease, color 0.4s ease;
  background-image: 
    radial-gradient(circle at 20% 80%, rgba(139, 92, 246, 0.08) 0%, transparent 40%),
    radial-gradient(circle at 80% 20%, rgba(0, 212, 255, 0.05) 0%, transparent 40%),
    radial-gradient(circle at 40% 40%, rgba(0, 216, 167, 0.05) 0%, transparent 40%);
}

/* Animated Background Elements */
.darkroot-bg-elements {
  position: fixed; top: 0; left: 0; width: 100%; height: 100%;
  pointer-events: none; z-index: -1;
}

.darkroot-bg-elements div {
  position: absolute; border-radius: 50%;
  filter: blur(60px); opacity: 0.15;
  animation: float 20s infinite ease-in-out both;
}

.bg-element-1 {
  width: 300px; height: 300px;
  background: var(--primary);
  top: 10%; left: 10%;
  animation-delay: 0s;
}

.bg-element-2 {
  width: 200px; height: 200px;
  background: var(--cyber-blue);
  top: 60%; right: 15%;
  animation-delay: 5s;
}

.bg-element-3 {
  width: 150px; height: 150px;
  background: var(--hacker-green);
  bottom: 20%; left: 20%;
  animation-delay: 10s;
}

.bg-element-4 {
  width: 180px; height: 180px;
  background: var(--deepseek-green);
  top: 30%; right: 30%;
  animation-delay: 15s;
}

@keyframes float {
  0%, 100% { transform: translate(0, 0) scale(1); opacity: 0.1; }
  33% { transform: translate(30px, -30px) scale(1.1); opacity: 0.15; }
  66% { transform: translate(-20px, 20px) scale(0.9); opacity: 0.2; }
}

/* ================= LAYOUT ================= */
.container {
  width: 100%; max-width: 1400px; height: 100%;
  background: transparent;
  display: flex; flex-direction: column; position: relative; overflow: hidden;
}

@media(min-width: 768px) {
  .container {
    height: 95vh;
    border-radius: 28px;
    border: 1px solid var(--border-color);
    background: rgba(15, 23, 42, 0.05);
    backdrop-filter: blur(15px);
    box-shadow: 
      0 25px 50px -12px rgba(0, 0, 0, 0.5),
      inset 0 1px 0 rgba(255, 255, 255, 0.1);
  }
  body.light-mode .container {
    background: rgba(255, 255, 255, 0.5);
    box-shadow: 
      0 20px 40px -10px rgba(0,0,0,0.1),
      inset 0 1px 0 rgba(255, 255, 255, 0.8);
  }
}

/* ================= SIDEBAR ================= */
#sidebar {
  position: fixed; top: 0; left: 0;
  width: 320px; height: 100%;
  background: var(--sidebar-bg);
  border-right: 1px solid var(--border-color);
  backdrop-filter: var(--glass-filter);
  z-index: 1000;
  transform: translateX(-100%);
  transition: transform 0.4s cubic-bezier(0.165, 0.84, 0.44, 1);
  display: flex; flex-direction: column;
  box-shadow: 20px 0 40px rgba(0,0,0,0.3);
}

#sidebar.open { transform: translateX(0); }

.sidebar-header {
  padding: 24px 20px;
  border-bottom: 1px solid var(--border-color);
  font-weight: 900; display: flex; justify-content: space-between; align-items: center;
  color: var(--text-primary);
  background: var(--primary-gradient);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  font-size: 1.5rem;
  letter-spacing: -0.5px;
}

.sidebar-section-title {
  padding: 20px 20px 12px 20px;
  font-size: 0.75rem; color: var(--text-secondary);
  font-weight: 800; letter-spacing: 1px; text-transform: uppercase;
  border-bottom: 1px solid var(--border-color);
  margin-bottom: 10px;
}

.sidebar-btn {
  width: calc(100% - 40px); margin: 8px 20px; padding: 14px 16px;
  background: var(--input-bg);
  border: 1px solid var(--border-color);
  color: var(--text-primary); border-radius: 12px;
  cursor: pointer; display: flex; align-items: center; gap: 12px;
  font-size: 0.95rem; font-weight: 500;
  transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
}
.sidebar-btn:hover { 
  background: var(--history-item-hover); 
  border-color: var(--primary);
  transform: translateX(5px);
  box-shadow: var(--shadow-glow);
}
.sidebar-btn i { 
  width: 20px; text-align: center; 
  background: var(--primary-gradient);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  font-size: 1.1rem;
}

/* Auth Form */
.auth-form input {
  width: 100%; padding: 12px; margin-bottom: 12px;
  background: var(--input-bg); border: 1px solid var(--border-color);
  color: var(--text-primary); border-radius: 8px; outline: none;
}
.auth-form input:focus { border-color: var(--primary); }
.auth-form button {
  width: 100%; padding: 12px; background: var(--accent-gradient); color: white;
  border: none; border-radius: 8px; cursor: pointer; font-weight: bold;
}
.auth-switch { margin-top: 15px; text-align: center; font-size: 0.85rem; color: var(--primary); cursor: pointer; }

/* Special Cyber Button */
.cyber-btn {
  background: rgba(0, 212, 255, 0.1);
  border: 1px solid var(--cyber-blue);
  color: var(--cyber-blue);
  position: relative;
  overflow: hidden;
}
.cyber-btn::before {
  content: '';
  position: absolute;
  top: 0; left: -100%;
  width: 100%; height: 100%;
  background: linear-gradient(90deg, transparent, rgba(0, 212, 255, 0.2), transparent);
  transition: left 0.6s;
}
.cyber-btn:hover::before {
  left: 100%;
}
.cyber-btn:hover {
  background: rgba(0, 212, 255, 0.2);
  border-color: var(--cyber-blue);
  box-shadow: 0 0 20px rgba(0, 212, 255, 0.3);
}

.hacker-btn {
  background: rgba(0, 255, 136, 0.1);
  border: 1px solid var(--hacker-green);
  color: var(--hacker-green);
}
.hacker-btn:hover {
  background: rgba(0, 255, 136, 0.2);
  border-color: var(--hacker-green);
  box-shadow: 0 0 20px rgba(0, 255, 136, 0.3);
}

.deepseek-btn {
  background: rgba(0, 216, 167, 0.1);
  border: 1px solid var(--deepseek-green);
  color: var(--deepseek-green);
}
.deepseek-btn:hover {
  background: rgba(0, 216, 167, 0.2);
  border-color: var(--deepseek-green);
  box-shadow: 0 0 20px rgba(0, 216, 167, 0.3);
}

/* HISTORY LIST */
.history-list {
  flex: 1; 
  overflow-y: auto; 
  padding: 15px 20px; 
}

.history-item {
  padding: 14px 16px; margin-bottom: 10px; border-radius: 14px;
  cursor: pointer; 
  background: var(--history-item-bg);
  color: var(--text-primary);
  border: 1px solid var(--border-color);
  display: flex; justify-content: space-between; align-items: center;
  transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1); 
  font-size: 0.9rem;
  font-weight: 500;
  position: relative;
}
.history-item:hover { 
  background: var(--history-item-hover); 
  border-color: var(--primary);
  transform: translateX(5px);
  box-shadow: 0 5px 15px rgba(139, 92, 246, 0.2);
}
.history-item.active { 
  background: rgba(139, 92, 246, 0.15); 
  color: var(--primary); 
  border-color: var(--primary);
  box-shadow: 0 0 0 1px var(--primary);
}
.history-item::after {
  content: '';
  position: absolute;
  top: 0; left: 0;
  width: 4px; height: 100%;
  background: var(--primary-gradient);
  border-radius: 4px 0 0 4px;
  opacity: 0;
  transition: opacity 0.3s;
}
.history-item.active::after {
  opacity: 1;
}

.delete-chat-btn { 
  background: none; border: none; 
  color: var(--text-secondary); cursor: pointer; 
  padding: 6px; border-radius: 6px;
  transition: all 0.2s;
}
.delete-chat-btn:hover { 
  background: rgba(239, 68, 68, 0.1); 
  color: var(--danger); 
}

/* OVERLAY */
#overlay {
  position: fixed; top: 0; left: 0; width: 100%; height: 100%;
  background: rgba(0,0,0,0.7); z-index: 900; display: none;
  backdrop-filter: blur(8px);
  animation: fadeIn 0.3s ease;
}
#overlay.active { display: block; }

@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}

/* ================= HEADER ================= */
.header {
  flex-shrink: 0; padding: 18px 24px;
  background: var(--sidebar-bg);
  border-bottom: 1px solid var(--border-color);
  backdrop-filter: var(--glass-filter);
  display: flex; justify-content: space-between; align-items: center; z-index: 100;
  position: relative;
}

.left-section { display: flex; align-items: center; gap: 18px; }
.menu-btn { 
  background: var(--input-bg); 
  border: 1px solid var(--border-color);
  color: var(--text-primary); 
  font-size: 1.2rem; 
  cursor: pointer; 
  width: 44px; height: 44px;
  border-radius: 12px;
  display: flex; align-items: center; justify-content: center;
  transition: all 0.2s;
}
.menu-btn:hover { 
  border-color: var(--primary);
  transform: scale(1.05);
  box-shadow: var(--shadow-glow);
}

.brand-name {
  font-weight: 900; font-size: 1.4rem;
  background: var(--cyber-gradient);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  display: flex; gap: 12px; align-items: center;
  letter-spacing: -0.5px;
  position: relative;
}
.brand-name::after {
  content: '';
  position: absolute;
  bottom: -5px; left: 0;
  width: 100%; height: 2px;
  background: var(--cyber-gradient);
  border-radius: 2px;
  opacity: 0.5;
}

.header-actions { display: flex; gap: 10px; }
.header-btn {
  background: var(--input-bg); border: 1px solid var(--border-color); color: var(--text-secondary);
  cursor: pointer; font-size: 0.9rem; padding: 10px 16px; border-radius: 12px;
  transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
  display: flex; align-items: center; gap: 8px;
  font-weight: 500;
}
.header-btn:hover { 
  color: var(--text-primary); 
  background: var(--panel-bg); 
  border-color: var(--primary);
  transform: translateY(-2px);
  box-shadow: 0 5px 15px rgba(139, 92, 246, 0.2);
}
.header-btn.new-chat { 
  background: var(--primary-gradient); 
  color: white; border: none; 
  box-shadow: var(--shadow-glow);
}
.header-btn.new-chat:hover {
  transform: translateY(-2px) scale(1.05);
  box-shadow: 0 8px 25px rgba(139, 92, 246, 0.4);
}

/* ================= CHAT AREA ================= */
.chat-area {
  flex: 1; min-height: 0; padding: 24px; overflow-y: auto;
  display: flex; flex-direction: column; gap: 24px; scroll-behavior: smooth;
  background: 
    radial-gradient(circle at 0% 0%, rgba(139, 92, 246, 0.05) 0%, transparent 50%),
    radial-gradient(circle at 100% 100%, rgba(0, 212, 255, 0.05) 0%, transparent 50%),
    radial-gradient(circle at 50% 50%, rgba(0, 216, 167, 0.05) 0%, transparent 50%);
}

.message-wrapper { 
  display: flex; flex-direction: column; max-width: 85%; 
  animation: slideUp 0.4s cubic-bezier(0.165, 0.84, 0.44, 1);
}
.message-wrapper.user { align-self: flex-end; align-items: flex-end; }
.message-wrapper.ai { align-self: flex-start; }

.bubble {
  padding: 18px 22px; border-radius: 20px; line-height: 1.7; font-size: 1rem; word-wrap: break-word;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
  position: relative;
  overflow: hidden;
}
.bubble::before {
  content: '';
  position: absolute;
  top: 0; left: 0;
  width: 100%; height: 100%;
  background: linear-gradient(135deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0) 100%);
  pointer-events: none;
}

.user .bubble { 
  background: var(--primary-gradient); 
  color: white; 
  border-bottom-right-radius: 6px; 
  box-shadow: 0 8px 25px rgba(139, 92, 246, 0.3);
}
.ai .bubble { 
  background: var(--panel-bg);
  color: var(--text-primary);
  border: 1px solid var(--border-color); 
  border-bottom-left-radius: 6px;
  backdrop-filter: blur(10px);
  box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
}

/* TYPING INDICATOR */
.typing-indicator {
  display: none; padding: 16px 20px; background: var(--panel-bg);
  border-radius: 20px; width: fit-content; border: 1px solid var(--border-color);
  box-shadow: 0 4px 12px rgba(0,0,0,0.1);
  backdrop-filter: blur(10px);
}
.typing-dot {
  display: inline-block; width: 8px; height: 8px; background-color: var(--primary);
  border-radius: 50%; animation: bounce 1.4s infinite ease-in-out both; margin: 0 3px;
}
.typing-dot:nth-child(1) { animation-delay: -0.32s; }
.typing-dot:nth-child(2) { animation-delay: -0.16s; }

/* ================= CODE SNIPPETS ================= */
.code-block-wrapper {
  margin-top: 16px; border-radius: 12px; overflow: hidden;
  border: 1px solid rgba(48, 54, 61, 0.5); background: #0d1117; width: 100%;
  box-shadow: 0 8px 32px rgba(0,0,0,0.3);
  animation: slideUp 0.4s ease;
}
.code-header {
  display: flex; justify-content: space-between; align-items: center;
  padding: 12px 16px; background: #161b22; border-bottom: 1px solid #30363d;
  font-size: 0.8rem; color: #8b949e;
  font-family: 'Fira Code', monospace;
}
.code-actions {
  display: flex; gap: 8px;
}
.code-actions button {
  background: rgba(255,255,255,0.05); border: 1px solid #30363d; color: #8b949e;
  border-radius: 6px; padding: 6px 12px; font-size: 0.75rem; cursor: pointer;
  transition: all 0.2s;
  display: flex; align-items: center; gap: 5px;
  font-family: 'Inter', sans-serif;
}
.code-actions button:hover { 
  color: white; border-color: white; 
  background: rgba(255,255,255,0.1);
  transform: translateY(-1px);
}
.btn-run { 
  color: var(--hacker-green) !important; 
  border-color: rgba(0, 255, 136, 0.3) !important; 
}
.btn-copy:hover { 
  color: var(--cyber-blue) !important; 
  border-color: var(--cyber-blue) !important; 
}

pre { margin: 0; padding: 0; overflow-x: auto; }
code.hljs { padding: 18px; font-family: 'Fira Code', monospace; font-size: 0.9rem; line-height: 1.6; }

/* ================= INPUT AREA ================= */
.input-area {
  flex-shrink: 0; padding: 20px 24px; background: var(--sidebar-bg);
  border-top: 1px solid var(--border-color); display: flex; gap: 12px; align-items: flex-end;
  padding-bottom: max(20px, env(safe-area-inset-bottom));
  backdrop-filter: var(--glass-filter);
  position: relative;
}
.input-area::before {
  content: '';
  position: absolute;
  top: 0; left: 0;
  width: 100%; height: 1px;
  background: var(--primary-gradient);
  opacity: 0.3;
}

.input-container {
  flex: 1; background: var(--input-bg); border: 1px solid var(--border-color);
  border-radius: 24px; padding: 14px 20px; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  display:flex; align-items:center; gap:12px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.05);
}
.input-container:focus-within { 
  border-color: var(--primary); 
  box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.2), 0 8px 24px rgba(139, 92, 246, 0.1);
  transform: translateY(-2px);
}
textarea {
  width: 100%; background: transparent; border: none; color: var(--text-primary);
  resize: none; outline: none; font-size: 1rem; max-height: 150px; min-height: 24px;
  font-family: 'Inter', sans-serif;
  line-height: 1.5;
}
textarea::placeholder {
  color: var(--text-secondary);
  opacity: 0.7;
}

#send-btn {
  width: 52px; height: 52px; border-radius: 50%; background: var(--primary-gradient);
  border: none; color: white; cursor: pointer; display: flex; justify-content: center; align-items: center;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  box-shadow: 0 6px 20px rgba(139, 92, 246, 0.4);
  font-size: 1.2rem;
  position: relative;
  overflow: hidden;
}
#send-btn::after {
  content: '';
  position: absolute;
  top: 0; left: 0;
  width: 100%; height: 100%;
  background: linear-gradient(45deg, transparent 30%, rgba(255,255,255,0.2) 50%, transparent 70%);
  transform: translateX(-100%);
}
#send-btn:hover { 
  transform: scale(1.08); 
  box-shadow: 0 10px 30px rgba(139, 92, 246, 0.6);
}
#send-btn:active::after {
  transform: translateX(100%);
  transition: transform 0.5s ease;
}

/* ================= MODALS ================= */
.modal {
  display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
  background: rgba(0,0,0,0.8); z-index: 2000;
  justify-content: center; align-items: center;
  backdrop-filter: blur(12px);
  animation: modalFadeIn 0.4s ease;
}

@keyframes modalFadeIn {
  from { opacity: 0; backdrop-filter: blur(0); }
  to { opacity: 1; backdrop-filter: blur(12px); }
}

.modal-content {
  background: var(--panel-bg); width: 90%; max-width: 500px;
  border-radius: 24px; border: 1px solid var(--border-color);
  padding: 32px; color: var(--text-primary);
  box-shadow: 
    0 30px 60px -12px rgba(0,0,0,0.5),
    0 0 0 1px rgba(255,255,255,0.05);
  animation: modalSlideUp 0.5s cubic-bezier(0.165, 0.84, 0.44, 1);
  max-height: 90vh;
  overflow-y: auto;
}

@keyframes modalSlideUp {
  from { opacity: 0; transform: translateY(40px); }
  to { opacity: 1; transform: translateY(0); }
}

.modal-header { 
  display: flex; justify-content: space-between; align-items: center;
  margin-bottom: 24px; padding-bottom: 20px; border-bottom: 1px solid var(--border-color);
}
.modal-header h3 {
  margin: 0;
  font-size: 1.5rem;
  background: var(--primary-gradient);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  font-weight: 800;
}

/* ================= IDE MODAL (ENHANCED FROM 36.HTML) ================= */
#ide-modal {
  display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
  background: #0d1117; z-index: 2001; flex-direction: column;
}

.ide-header {
  height: 60px; background: #161b22; border-bottom: 1px solid #30363d;
  display: flex; justify-content: space-between; align-items: center; padding: 0 20px;
  flex-shrink: 0;
}

.ide-controls { display: flex; gap: 12px; align-items: center; }
.ide-btn {
  padding: 8px 16px; border-radius: 8px; border: 1px solid #30363d;
  background: #21262d; color: #c9d1d9; cursor: pointer; font-size: 0.85rem;
  display: flex; align-items: center; gap: 8px; transition: all 0.2s;
  font-family: 'Fira Code', monospace;
}
.ide-btn:hover { background: #30363d; transform: translateY(-1px); }
.ide-btn.primary { 
  background: linear-gradient(135deg, #238636, #2ea043); 
  border-color: #238636; color: white; 
  box-shadow: 0 4px 12px rgba(35, 134, 54, 0.3);
}
.ide-btn.danger { 
  background: rgba(248, 81, 73, 0.1); 
  border-color: #f85149; color: #f85149; 
}
.ide-btn.deepseek { 
  background: rgba(0, 216, 167, 0.1); 
  border-color: var(--deepseek-green); color: var(--deepseek-green); 
}
.ide-btn.deepseek:hover { 
  background: rgba(0, 216, 167, 0.2); 
}

.mobile-tabs {
  display: none;
  background: #0d1117;
  border-bottom: 1px solid #30363d;
  flex-shrink: 0;
}
.mobile-tab {
  flex: 1;
  padding: 12px;
  text-align: center;
  color: #8b949e;
  font-size: 0.9rem;
  cursor: pointer;
  border-bottom: 2px solid transparent;
  transition: 0.2s;
}
.mobile-tab.active {
  color: white;
  border-bottom-color: #f78166;
  background: #161b22;
}

.ide-workspace { 
  flex: 1; 
  display: flex; 
  flex-direction: row; 
  overflow: hidden; 
  position: relative; 
}

#editor-pane {
  flex: 1;
  width: 50%;
  border-right: 1px solid #30363d;
  position: relative;
  display: flex;
  flex-direction: column;
}

#preview-pane {
  flex: 1;
  width: 50%;
  display: flex;
  flex-direction: column;
  position: relative;
}

/* Console Pane */
.console-pane {
  background: #0d1117; 
  border-top: 1px solid #30363d;
  display: flex; 
  flex-direction: column;
  height: 40%;
  min-height: 200px;
}

.console-header {
  background: #161b22;
  padding: 10px 15px;
  border-bottom: 1px solid #30363d;
  display: flex;
  justify-content: space-between;
  align-items: center;
  font-family: 'Fira Code', monospace;
  color: #c9d1d9;
  font-size: 0.9rem;
}

.console-logs {
  flex: 1;
  overflow-y: auto;
  padding: 15px;
  font-family: 'Fira Code', monospace;
  font-size: 0.85rem;
  color: #c9d1d9;
}

.log-line {
  margin-bottom: 8px;
  padding: 8px 12px;
  border-radius: 6px;
  background: rgba(255,255,255,0.03);
  border-left: 3px solid #30363d;
}

.log-line.log { border-left-color: #58a6ff; }
.log-line.error { border-left-color: #f85149; background: rgba(248,81,73,0.05); }
.log-line.success { border-left-color: #238636; background: rgba(35,134,54,0.05); }

/* Input for stdin */
#stdin-wrapper {
  display: none;
  padding: 15px;
  background: #0b1120;
  border-bottom: 1px solid #30363d;
}
#program-stdin {
  width: 100%;
  height: 60px;
  background: #161b22;
  color: #e6edf3;
  border: 1px solid #30363d;
  border-radius: 6px;
  padding: 8px;
  font-family: monospace;
  font-size: 0.85rem;
  outline: none;
}

.preview-frame {
  width: 100%;
  height: 100%;
  border: none;
  background: white;
}

#ide-status {
  position: absolute;
  bottom: 8px;
  right: 15px;
  font-size: 0.75rem;
  color: #8b949e;
  z-index: 10;
  background: rgba(13, 17, 23, 0.8);
  padding: 2px 6px;
  border-radius: 4px;
}

@media (max-width: 768px) {
  .ide-workspace {
    flex-direction: column;
  }
  .mobile-tabs {
    display: flex;
  }
  #editor-pane, #preview-pane {
    width: 100%;
    display: none;
  }
  #editor-pane.active, #preview-pane.active {
    display: flex;
  }
}

/* ================= STUDY MODAL ================= */
.study-categories {
  display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
  gap: 16px; margin: 20px 0;
}

.study-card {
  background: var(--input-bg); border: 1px solid var(--border-color);
  border-radius: 16px; padding: 20px; cursor: pointer;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  display: flex; flex-direction: column; align-items: center;
  text-align: center;
}
.study-card:hover {
  transform: translateY(-5px);
  border-color: var(--hacker-green);
  box-shadow: 0 10px 30px rgba(0, 255, 136, 0.2);
  background: rgba(0, 255, 136, 0.05);
}
.study-card i {
  font-size: 2rem; margin-bottom: 12px;
  background: linear-gradient(135deg, #00ff88, #00d4ff);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
}
.study-card h4 {
  margin: 0 0 8px 0; color: var(--text-primary);
}
.study-card p {
  margin: 0; color: var(--text-secondary); font-size: 0.85rem;
}

/* ================= RESPONSIVE ================= */
@media (max-width: 768px) {
  .container { border-radius: 0; height: 100%; }
  #sidebar { width: 100%; max-width: 320px; }
  .chat-area { padding: 16px; }
  .message-wrapper { max-width: 95%; }
  .header { padding: 16px; }
  .input-area { padding: 16px; }
  .study-categories { grid-template-columns: 1fr; }
  
  .brand-name { font-size: 1.2rem; }
  .header-btn span:not(.mobile-only) { display: none; }
  .header-btn { padding: 10px; }
}

/* ================= ANIMATIONS ================= */
@keyframes bounce { 
  0%, 80%, 100% { transform: scale(0); } 
  40% { transform: scale(1); } 
}
@keyframes slideUp { 
  from { opacity: 0; transform: translateY(30px); } 
  to { opacity: 1; transform: translateY(0); } 
}

/* ================= SCROLLBAR ================= */
::-webkit-scrollbar {
  width: 8px; height: 8px;
}
::-webkit-scrollbar-track {
  background: rgba(255,255,255,0.05);
  border-radius: 4px;
}
::-webkit-scrollbar-thumb {
  background: var(--primary);
  border-radius: 4px;
}
::-webkit-scrollbar-thumb:hover {
  background: var(--cyber-blue);
}

/* ================= LOADING STATES ================= */
.loading-bar {
  height: 3px; width: 100%; background: linear-gradient(90deg, var(--primary), var(--cyber-blue), var(--hacker-green), var(--deepseek-green));
  position: absolute; top: 0; left: 0;
  animation: loading 2s infinite ease-in-out;
  transform-origin: left;
}
@keyframes loading {
  0% { transform: scaleX(0); }
  50% { transform: scaleX(1); }
  100% { transform: scaleX(0); }
}

/* ================= UTILITY CLASSES ================= */
.glass {
  background: rgba(255,255,255,0.05);
  backdrop-filter: blur(10px);
  border: 1px solid rgba(255,255,255,0.1);
}
.cyber-text {
  background: var(--cyber-gradient);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  font-weight: 800;
}
.deepseek-text {
  background: linear-gradient(135deg, var(--deepseek-green), #00d4ff);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  font-weight: 800;
}
.gradient-border {
  border: 2px solid transparent;
  background: linear-gradient(var(--panel-bg), var(--panel-bg)) padding-box,
              var(--primary-gradient) border-box;
}
.pulse {
  animation: pulse 2s infinite;
}
@keyframes pulse {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.7; }
}

/* ================= PROMPT SUGGESTIONS ================= */
.prompt-suggestions-container {
  background: var(--panel-bg); border: 1px solid var(--border-color);
  border-radius: 16px; padding: 20px; margin-bottom: 20px;
  box-shadow: 0 10px 30px rgba(0,0,0,0.2);
}
.prompt-suggestion {
  padding: 12px 16px; margin-bottom: 10px; border-radius: 12px;
  background: var(--input-bg); border: 1px solid var(--border-color);
  cursor: pointer; transition: all 0.2s;
  color: var(--text-primary);
}
.prompt-suggestion:hover {
  background: var(--history-item-hover); border-color: var(--primary);
  transform: translateX(5px);
}

/* MUSIC PLAYER STYLES */
.music-player {
  background: var(--input-bg); 
  padding: 15px; 
  border-radius: 12px;
  text-align: center; 
  margin-top: 15px; 
  border: 1px solid var(--border-color);
}

.music-controls { 
  display:flex; 
  justify-content:center; 
  gap:10px; 
  margin-top:10px; 
}

.music-controls button {
  background: var(--bg-color); 
  color: var(--text-primary); 
  border: 1px solid var(--border-color);
  width: 40px; 
  height: 40px; 
  border-radius: 50%;
  cursor: pointer; 
  font-size: 0.9rem;
}

.music-controls button.play-btn { 
  background: var(--primary); 
  color:white; 
  border:none; 
  width:50px; 
  height:50px; 
  font-size:1.1rem; 
}
</style>
</head>
<body>

<!-- Background Elements -->
<div class="darkroot-bg-elements">
  <div class="bg-element-1"></div>
  <div class="bg-element-2"></div>
  <div class="bg-element-3"></div>
  <div class="bg-element-4"></div>
</div>

<!-- AUDIO -->
<audio id="bg-music"></audio>
<audio id="sfx-click" src="computer-mouse-click-352734.mp3"></audio>
<audio id="sfx-sent" src="https://assets.mixkit.co/active_storage/sfx/2354/2354-preview.mp3"></audio>

<!-- OVERLAY & SIDEBAR -->
<div id="overlay" onclick="toggleSidebar()"></div>
<div id="sidebar">
  <div class="sidebar-header">
    <span><i class="fas fa-infinity"></i> DarkRoot AI</span>
    <button onclick="toggleSidebar()" style="background:rgba(255,255,255,0.1); border:none; color:var(--text-primary); font-size:1.5rem; cursor:pointer; width:40px; height:40px; display:flex; align-items:center; justify-content:center; border-radius:10px;">&times;</button>
  </div>
  
  <!-- User Panel (Enhanced) -->
  <div id="user-panel" style="display:none; padding:20px; border-bottom:1px solid var(--border-color);">
    <div style="display:flex; align-items:center; gap:15px;">
      <div style="width:50px; height:50px; border-radius:50%; background:var(--primary-gradient); display:flex; align-items:center; justify-content:center; color:white; font-weight:bold; font-size:1.2rem;" id="user-avatar">U</div>
      <div style="flex:1;">
        <div style="font-weight:600; color:var(--text-primary);" id="user-display-name">User</div>
        <div style="font-size:0.8rem; color:var(--text-secondary);" id="user-display-email">user@example.com</div>
      </div>
    </div>
  </div>
  
  <!-- Quick Actions -->
  <div class="sidebar-section-title">QUICK ACTIONS</div>
  <button class="sidebar-btn cyber-btn" onclick="openStudyModal(); playSound('click')">
    <i class="fas fa-shield-alt"></i> Study Legal Hacking
  </button>
  <button class="sidebar-btn" onclick="openEmptyIde(); playSound('click')">
    <i class="fas fa-code"></i> Enhanced Code Editor
  </button>
  <button class="sidebar-btn" onclick="openPromptManager(); playSound('click')">
    <i class="fas fa-lightbulb"></i> Prompt Ideas
  </button>
  <button class="sidebar-btn deepseek-btn" onclick="activateDeepSeekAI(); playSound('click')">
    <i class="fas fa-brain"></i> Activate DeepSeek AI
  </button>
  
  <!-- RECENT SESSIONS -->
  <div class="sidebar-section-title">RECENT SESSIONS</div>
  <div class="history-list" id="history-list">
    <!-- Sessions will be loaded here -->
  </div>
  
  <!-- System Tools -->
  <div style="padding:20px 15px 0 15px;">
    <button class="sidebar-btn" onclick="openSettings(); playSound('click')">
      <i class="fas fa-cog"></i> System Settings
    </button>
    <button class="sidebar-btn" onclick="exportChat(); playSound('click')">
      <i class="fas fa-file-export"></i> Export Chat
    </button>
    <button class="sidebar-btn" onclick="openAbout(); playSound('click')">
      <i class="fas fa-info-circle"></i> System Info
    </button>
  </div>

  <!-- Auth Section -->
  <div id="auth-section" style="padding:20px; margin-top:auto; border-top:1px solid var(--border-color); text-align:center;">
    <div class="auth-status" id="auth-status">Guest Mode</div>
    <button class="auth-btn btn-login" id="login-btn" onclick="openAuthModal()" style="width:100%; padding:12px; border-radius:12px; background:var(--primary-gradient); color:white; border:none; cursor:pointer; font-weight:600; margin-top:10px;">
      <i class="fas fa-sign-in-alt"></i> Login / Sign Up
    </button>
    <button class="auth-btn btn-logout" id="logout-btn" onclick="logout()" style="width:100%; padding:12px; border-radius:12px; background:rgba(239,68,68,0.1); border:1px solid var(--danger); color:var(--danger); cursor:pointer; font-weight:600; margin-top:10px; display:none;">
      <i class="fas fa-sign-out-alt"></i> Logout
    </button>
  </div>
</div>

<!-- AUTH MODAL -->
<div id="auth-modal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3 id="auth-title">Authentication</h3>
      <button onclick="closeAuthModal()" style="background:none; border:none; color:var(--text-primary); cursor:pointer; font-size:1.5rem;">&times;</button>
    </div>
    <div class="auth-form">
      <input type="text" id="auth-name" placeholder="Full Name (Required)" autocomplete="name">
      <input type="email" id="auth-email" placeholder="Email Address" autocomplete="email">
      <input type="password" id="auth-password" placeholder="Password" autocomplete="current-password">
      <div style="display:flex; align-items:center; gap:10px; margin-bottom:15px;">
        <input type="checkbox" id="remember-me" style="width:auto;">
        <label for="remember-me" style="color:var(--text-secondary); font-size:0.9rem;">Remember me (Auto-login)</label>
      </div>
      <button onclick="handleAuth()" id="auth-submit" style="width:100%; padding:14px; background:var(--primary-gradient); color:white; border:none; border-radius:12px; cursor:pointer; font-weight:bold; font-size:1rem;">Login</button>
      <div class="auth-switch" onclick="toggleAuthMode()" id="auth-switch-text" style="margin-top:15px; text-align:center; color:var(--primary); cursor:pointer; font-size:0.9rem;">
        Don't have an account? Sign up
      </div>
    </div>
  </div>
</div>

<!-- SETTINGS MODAL -->
<div id="settings-modal" class="modal">
  <div class="modal-content">
    <div class="modal-header"><h3>System Settings</h3><button onclick="closeSettings()" style="background:none; border:none; color:var(--text-primary); cursor:pointer;">&times;</button></div>
    
    <div class="setting-item">
      <span>AI Engine</span>
    <select id="model-select" class="setting-select" onchange="changeModel()" style="background:var(--input-bg); color:var(--text-primary); border:1px solid var(--border-color); padding:10px; border-radius:10px; width:200px;">
  <option value="deepseek/deepseek-chat" selected>DeepSeek V3 (Default)</option>
  <option value="google/gemini-2.0-flash-001">Gemini 2.0 Flash</option>
  <option value="meta-llama/llama-3-70b-instruct">Llama 3 70B</option>
  <option value="mistralai/mistral-7b-instruct">Mistral 7B</option>
  <option value="arcee-ai/trinity-large-preview:free">Trinity Ai</option>
  <option value="gpt-oss-20b">GPT-OSS 20B</option>
  <option value="meta-llama/llama-3.3-70b-instruct">Llama 3.3 70B</option>
  <option value="gpt-oss-120b">GPT-OSS 120B</option>  
  <option value="nvidia/nemotron-3-nano-30b-a3b">NVIDIA Nemotron 3</option>    
  <option value="liquid/lfm-2.5-1.2b-thinking:free">Liquid LFM</option>   
  <option value="nvidia/nemotron-3-nano-30b-a3b:free">Nemotron 30b</option>
</select>
    </div>
    <br>
    <div class="setting-item">
      <span>Theme Mode</span>
      <label class="switch"><input type="checkbox" id="theme-toggle" checked onchange="toggleTheme()"><span class="slider"></span></label>
    </div>

    <div class="music-player">
      <div id="track-name" style="margin-bottom:10px; font-size:0.9rem; color:var(--primary); font-weight:bold; font-family:monospace;">Ready</div>
      <div class="music-controls">
        <button onclick="prevTrack(); playSound('click')"><i class="fas fa-step-backward"></i></button>
        <button class="play-btn" onclick="toggleMusic(); playSound('click')"><i class="fas fa-play" id="play-icon"></i></button>
        <button onclick="nextTrack(); playSound('click')"><i class="fas fa-step-forward"></i></button>
      </div>
    </div>
    <br>
    <div class="setting-item">
      <span>Response Length</span>
      <select id="response-length" class="setting-select" style="background:var(--input-bg); color:var(--text-primary); border:1px solid var(--border-color); padding:8px; border-radius:8px;">
        <option value="2048">Normal (2048 tokens)</option>
        <option value="4096">Long (4096 tokens)</option>
        <option value="8192">Very Long (8192 tokens)</option>
      </select>
    </div>
    <br>
    <div class="setting-item">
      <span>Custom Prompts</span>
      <button onclick="openPromptManager()" style="padding:10px 18px; background:rgba(139,92,246,0.1); border:1px solid var(--primary); color:var(--primary); border-radius:10px; cursor:pointer; font-weight:500;">Manage Prompts</button>
    </div>
    
    <div class="setting-item" style="margin-top:30px;">
      <button onclick="clearContext()" style="width:100%; padding:16px; background:rgba(239,68,68,0.1); color:#ef4444; border:1px solid #ef4444; border-radius:14px; font-weight:600; cursor:pointer;">
        <i class="fas fa-eraser"></i> Clear Session Memory
      </button>
    </div>
  </div>
</div>

<!-- STUDY LEGAL HACKING MODAL -->
<div id="study-modal" class="modal">
  <div class="modal-content" style="max-width:700px;">
    <div class="modal-header">
      <h3><i class="fas fa-shield-alt"></i> Legal Hacking & Cybersecurity</h3>
      <button onclick="closeStudyModal()" style="background:none; border:none; color:var(--text-primary); cursor:pointer; font-size:1.5rem;">&times;</button>
    </div>
    
    <div style="margin-bottom:25px; color:var(--text-secondary);">
      Learn ethical hacking, penetration testing, and cybersecurity fundamentals. All courses are legal and educational.
    </div>
    
    <div class="study-categories">
      <div class="study-card" onclick="startHackingCourse('basics')">
        <i class="fas fa-user-secret"></i>
        <h4>Ethical Hacking Basics</h4>
        <p>Introduction to legal penetration testing</p>
      </div>
      
      <div class="study-card" onclick="startHackingCourse('networking')">
        <i class="fas fa-network-wired"></i>
        <h4>Network Security</h4>
        <p>Firewalls, VPNs, and network protocols</p>
      </div>
      
      <div class="study-card" onclick="startHackingCourse('web')">
        <i class="fas fa-code"></i>
        <h4>Web Application Security</h4>
        <p>SQLi, XSS, CSRF protection</p>
      </div>
      
      <div class="study-card" onclick="startHackingCourse('cryptography')">
        <i class="fas fa-lock"></i>
        <h4>Cryptography</h4>
        <p>Encryption, hashing, and security protocols</p>
      </div>
      
      <div class="study-card" onclick="startHackingCourse('forensics')">
        <i class="fas fa-search"></i>
        <h4>Digital Forensics</h4>
        <p>Incident response and investigation</p>
      </div>
      
      <div class="study-card" onclick="startHackingCourse('tools')">
        <i class="fas fa-tools"></i>
        <h4>Security Tools</h4>
        <p>Wireshark, Nmap, Metasploit basics</p>
      </div>
    </div>
    
    <div style="margin-top:30px; padding:20px; background:rgba(0, 216, 167, 0.05); border-radius:16px; border:1px solid var(--deepseek-green);">
      <h4 style="color:var(--deepseek-green); margin-top:0;"><i class="fas fa-brain"></i> DeepSeek AI Assistant</h4>
      <p style="color:var(--text-secondary); margin-bottom:15px;">Advanced AI model with enhanced coding and cybersecurity capabilities. Default engine with superior performance.</p>
      <button onclick="activateDeepSeekAI()" style="padding:12px 24px; background:linear-gradient(135deg, var(--deepseek-green), #8b5cf6); color:white; border:none; border-radius:12px; cursor:pointer; font-weight:600; width:100%;">
        <i class="fas fa-rocket"></i> Activate DeepSeek AI Mode
      </button>
      <div style="margin-top:10px; font-size:0.8rem; color:var(--text-secondary);">
        <i class="fas fa-key"></i> Using: DeepSeek V3 (Default)
      </div>
    </div>
  </div>
</div>

<!-- PROMPT MANAGER MODAL (Fixed) -->
<div id="prompt-modal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3><i class="fas fa-lightbulb"></i> Prompt Manager</h3>
      <button onclick="closePromptManager()" style="background:none; border:none; color:var(--text-primary); cursor:pointer; font-size:1.5rem;">&times;</button>
    </div>
    
    <div id="prompt-list" style="margin-bottom:25px;">
      <h4 style="margin-bottom:15px; color:var(--text-primary);">Saved Prompts</h4>
      <!-- Prompts will be loaded here -->
    </div>
    
    <div style="padding-top:25px; border-top:1px solid var(--border-color);">
      <h4 style="margin-bottom:15px; color:var(--text-primary);">Add New Prompt</h4>
      <input type="text" id="new-prompt-title" placeholder="Prompt Title" style="width:100%; padding:12px; margin-bottom:12px; border-radius:10px; border:1px solid var(--border-color); background:var(--input-bg); color:var(--text-primary); font-size:1rem;">
      <textarea id="new-prompt-content" placeholder="Prompt Content..." style="width:100%; height:120px; padding:12px; margin-bottom:15px; border-radius:10px; border:1px solid var(--border-color); background:var(--input-bg); color:var(--text-primary); resize:vertical; font-size:1rem; line-height:1.5;"></textarea>
      <button onclick="addCustomPrompt()" style="width:100%; padding:14px; background:var(--primary-gradient); color:white; border:none; border-radius:12px; cursor:pointer; font-weight:bold; font-size:1rem;">
        <i class="fas fa-plus"></i> Add Prompt
      </button>
    </div>
  </div>
</div>

<!-- MAIN INTERFACE -->
<div class="container">
  <!-- HEADER -->
  <div class="header">
    <div class="left-section">
      <button class="menu-btn" onclick="toggleSidebar()"><i class="fas fa-bars"></i></button>
      <div class="brand-name"><i class="fas fa-infinity"></i> DarkRoot AI</div>
    </div>
    <div class="header-actions">
      <button class="header-btn" onclick="openEmptyIde(); playSound('click')" title="Code Editor">
        <i class="fas fa-code"></i> <span class="desktop-only">Editor</span>
      </button>
      <button class="header-btn" onclick="openStudyModal(); playSound('click')" title="Legal Hacking">
        <i class="fas fa-shield-alt"></i> <span class="desktop-only">Hacking</span>
      </button>
      <button class="header-btn deepseek-btn" onclick="activateDeepSeekAI(); playSound('click')" title="DeepSeek AI">
        <i class="fas fa-brain"></i> <span class="desktop-only">DeepSeek AI</span>
      </button>
      <button class="header-btn" onclick="openSettings(); playSound('click')" title="Settings">
        <i class="fas fa-cog"></i> <span class="desktop-only">Settings</span>
      </button>
      <button class="header-btn new-chat" onclick="startNewChat(); playSound('click')" title="New Chat">
        <i class="fas fa-plus"></i> <span class="desktop-only">New Chat</span>
      </button>
    </div>
  </div>

  <!-- CHAT AREA -->
  <div class="chat-area" id="chat-container">
    <!-- Welcome Message -->
    <div class="message-wrapper ai">
      <div class="bubble">
        <strong><span class="cyber-text">DarkRoot AI</span> Online</strong><br>
        Advanced AI assistant ready for coding, cybersecurity, and technical problem-solving. 
        Features include gesture-controlled IDE, legal hacking courses, DeepSeek AI integration, and enhanced prompt management.
        <div style="margin-top:10px; font-size:0.85rem; color:var(--text-secondary);">
          <i class="fas fa-star"></i> Try: <code>/hack</code> for cybersecurity | <code>/code</code> for programming | <code>/deepseek</code> for DeepSeek AI | <code>/study</code> for courses
        </div>
        <div style="margin-top:10px; padding:10px; background:rgba(0, 216, 167, 0.1); border-radius:8px; border-left:3px solid var(--deepseek-green);">
          <i class="fas fa-check-circle" style="color:var(--deepseek-green);"></i> DeepSeek AI is <strong>enabled by default</strong> for superior performance!
        </div>
      </div>
    </div>
    
    <!-- Prompt Suggestions -->
    <div id="prompt-suggestions" class="prompt-suggestions-container" style="display:none;">
      <div style="margin-bottom:15px; color:var(--primary); font-size:0.9rem; font-weight:600;">
        <i class="fas fa-lightbulb"></i> Try these prompts:
      </div>
      <!-- Dynamic prompts will be inserted here -->
    </div>
    
    <!-- Typing Indicator -->
    <div id="typing-indicator" class="typing-indicator" style="display:none;">
      <div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div>
    </div>
  </div>

  <!-- INPUT AREA -->
  <div class="input-area">
    <div class="input-container">
      <textarea id="user-input" placeholder="Message DarkRoot AI... (Shift+Enter for new line, Enter to send)" rows="1"></textarea>
      <button id="mic-btn" onclick="toggleVoiceInput()" style="background:none; border:none; color:var(--text-secondary); cursor:pointer; font-size:1.2rem; width:40px; height:40px; display:flex; align-items:center; justify-content:center; border-radius:50%;">
        <i class="fas fa-microphone"></i>
      </button>
    </div>
    <button id="send-btn" onclick="sendMessage()">
      <i class="fa-solid fa-paper-plane"></i>
    </button>
  </div>
</div>

<!-- IDE MODAL (Enhanced with 36.html UI/UX) -->
<div id="ide-modal">
  <div class="ide-header">
    <div style="font-family:'Fira Code', monospace; color:#c9d1d9; font-weight:600; font-size:1.1rem;">
      <i class="fas fa-code"></i>IDE
    </div>
    <div class="ide-controls">
      <select id="lang-select" onchange="changeEditorLang()" style="background:#21262d; color:white; border:1px solid #30363d; border-radius:8px; padding:8px 12px; font-size:0.85rem; font-family:'Fira Code', monospace;">
        <option value="html">HTML/JS</option>
        <option value="python">Python</option>
        <option value="c">C</option>
        <option value="cpp">C++</option>
        <option value="javascript">JavaScript</option>
      </select>
      <button class="ide-btn" onclick="changeFontSize(1)">+</button>
      <button class="ide-btn" onclick="changeFontSize(-1)">-</button>
      <button class="ide-btn primary" onclick="runEditorCode(); playSound('click')"><i class="fas fa-play"></i> Run</button>
      <button class="ide-btn" onclick="downloadCode()"><i class="fas fa-download"></i> Save</button>
      <button class="ide-btn deepseek" onclick="activateDeepSeekAI(); closeIde();"><i class="fas fa-brain"></i> DeepSeek</button>
      <button class="ide-btn danger" onclick="closeIde()"><i class="fas fa-times"></i></button>
    </div>
  </div>
  
  <!-- Mobile Tabs -->
  <div class="mobile-tabs">
    <div class="mobile-tab active" onclick="switchTab('editor')" id="tab-editor">Code Editor</div>
     </div>

  <div class="ide-workspace">
    <div id="editor-pane" class="active">
      <div id="ace-editor" style="width:100%; height:100%;"></div>
      <div id="ide-status">Ready</div>
    </div>
    
    <div id="preview-pane">
      <div id="stdin-wrapper">
        <div style="font-size:0.8rem; color:#94a3b8; margin-bottom:6px;">Standard Input (Optional)</div>
        <textarea id="program-stdin" placeholder="Enter input data here..."></textarea>
      </div>
      <iframe id="preview-frame" class="preview-frame"></iframe>
      
      <!-- Console Pane -->
      <div class="console-pane">
        <div class="console-header">
          <span><i class="fas fa-terminal"></i> Console Output</span>
          <button onclick="clearConsole()" style="background:none; border:none; color:#8b949e; cursor:pointer; font-size:0.8rem;">
            <i class="fas fa-trash"></i> Clear
          </button>
        </div>
        <div class="console-logs" id="console-logs">
          <!-- Console output will appear here -->
          <div class="log-line log">Console ready. Run your code to see output.</div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- FIREBASE SDK -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged, updateProfile, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
  import { getFirestore, doc, setDoc, getDoc, collection, addDoc, getDocs, deleteDoc, query, where } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
  import { getDatabase, ref, child, get } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

  const firebaseConfig = { 
    apiKey: "AIzaSyBw9l9Zc0sUosH2Vtx1BgY9sqQOFtoQmmI", 
    authDomain: "darkroot-ai.firebaseapp.com", 
    databaseURL: "https://darkroot-ai-default-rtdb.europe-west1.firebasedatabase.app", 
    projectId: "darkroot-ai", 
    storageBucket: "darkroot-ai.firebasestorage.app", 
    messagingSenderId: "996214418394", 
    appId: "1:996214418394:web:24d0fc6457b491eb43aee3" 
  };
  
  let app, auth, db, rtdb, currentUser, userData = {};
  let autoLoginAttempted = false;

  async function initFirebase() {
    try {
      app = initializeApp(firebaseConfig); 
      auth = getAuth(app); 
      db = getFirestore(app); 
      rtdb = getDatabase(app);
      
      // Set persistence for auto-login
      await setPersistence(auth, browserLocalPersistence);
      
      console.log("Firebase Online - DarkRoot AI");
      
      // Load API Key
      const dbRef = ref(rtdb);
      try {
        const snap = await get(child(dbRef, `config/api_key`));
        if (snap.exists()) { 
          window.OPENROUTER_API_KEY = snap.val(); 
          console.log("OpenRouter API Key Loaded"); 
        } else {
          console.warn("API key not found in database");
        }
      } catch (err) { 
        console.warn("Key Fetch Error", err); 
      }
      
      setupAuth();
      loadCustomPrompts();
      attemptAutoLogin();
    } catch (e) { 
      console.error("Firebase Error", e); 
    }
  }

  function setupAuth() {
    onAuthStateChanged(auth, async (user) => {
      const authStatus = document.getElementById('auth-status');
      const loginBtn = document.getElementById('login-btn');
      const logoutBtn = document.getElementById('logout-btn');
      const userPanel = document.getElementById('user-panel');
      const userDisplayName = document.getElementById('user-display-name');
      const userDisplayEmail = document.getElementById('user-display-email');
      const userAvatar = document.getElementById('user-avatar');
      
      if (user) {
        currentUser = user; 
        if (authStatus) authStatus.innerText = user.email || "User";
        
        if (loginBtn) loginBtn.style.display = 'none'; 
        if (logoutBtn) logoutBtn.style.display = 'block';
        
        // Show user panel
        if (userPanel) userPanel.style.display = 'flex';
        if (userDisplayName) userDisplayName.innerText = user.displayName || user.email.split('@')[0] || "User";
        if (userDisplayEmail) userDisplayEmail.innerText = user.email || "";
        if (userAvatar) userAvatar.innerText = (user.displayName || user.email || "U")[0].toUpperCase();
        
        // Load user sessions
        try {
          const docSnap = await getDoc(doc(db, "users", user.uid));
          if (docSnap.exists() && docSnap.data().sessions) { 
            window.sessions = JSON.parse(JSON.stringify(docSnap.data().sessions)); 
            if (window.renderHistoryList) window.renderHistoryList();
          }
          userData = docSnap.exists() ? docSnap.data() : {};
        } catch(e) {
          console.error("Error loading user data:", e);
        }
      } else {
        if (authStatus) authStatus.innerText = "Guest Mode";
        if (loginBtn) loginBtn.style.display = 'block'; 
        if (logoutBtn) logoutBtn.style.display = 'none';
        if (userPanel) userPanel.style.display = 'none';
      }
    });
  }

  // Auto-login function
  async function attemptAutoLogin() {
    if (autoLoginAttempted) return;
    autoLoginAttempted = true;
    
    try {
      const savedEmail = localStorage.getItem('darkroot_remember_email');
      const savedPassword = localStorage.getItem('darkroot_remember_password');
      const rememberMe = localStorage.getItem('darkroot_remember_me') === 'true';
      
      if (rememberMe && savedEmail && savedPassword) {
        console.log("Attempting auto-login...");
        await signInWithEmailAndPassword(auth, savedEmail, savedPassword);
        console.log("Auto-login successful");
      }
    } catch (error) {
      console.log("Auto-login failed:", error.message);
      // Clear invalid credentials
      localStorage.removeItem('darkroot_remember_email');
      localStorage.removeItem('darkroot_remember_password');
    }
  }

  // EXPORTED FUNCTIONS
  window.openAuthModal = () => { 
    const modal = document.getElementById('auth-modal');
    if (modal) modal.style.display = 'flex'; 
    window.toggleSidebar(false); 
  }
  
  window.closeAuthModal = () => { 
    const modal = document.getElementById('auth-modal');
    if (modal) modal.style.display = 'none'; 
    
    const nameInput = document.getElementById('auth-name');
    const emailInput = document.getElementById('auth-email');
    const passwordInput = document.getElementById('auth-password');
    
    if (nameInput) nameInput.value = '';
    if (emailInput) emailInput.value = '';
    if (passwordInput) passwordInput.value = '';
  }
  
  window.toggleAuthMode = () => { 
    window.isSignUp = !window.isSignUp; 
    const authTitle = document.getElementById('auth-title');
    const authSubmit = document.getElementById('auth-submit');
    const authSwitchText = document.getElementById('auth-switch-text');
    
    if (authTitle) authTitle.innerText = window.isSignUp ? "Create Account" : "Login"; 
    if (authSubmit) authSubmit.innerText = window.isSignUp ? "Sign Up" : "Login"; 
    if (authSwitchText) authSwitchText.innerText = window.isSignUp ? "Already have an account? Login" : "Don't have an account? Sign up";
  }
  
  window.isSignUp = false;
  
  window.handleAuth = async () => {
    const name = document.getElementById('auth-name')?.value?.trim() || "";
    const email = document.getElementById('auth-email')?.value?.trim() || "";
    const password = document.getElementById('auth-password')?.value || "";
    const rememberMe = document.getElementById('remember-me')?.checked || false;
    
    if (!name && window.isSignUp) {
      alert("Please enter your name");
      return;
    }
    
    if (!email || !password) {
      alert("Please enter email and password");
      return;
    }
    
    try { 
      if(window.isSignUp) {
        // Create user with email/password
        const userCredential = await createUserWithEmailAndPassword(auth, email, password);
        // Update profile with name
        await updateProfile(userCredential.user, { displayName: name });
        // Create user document in Firestore
        await setDoc(doc(db, "users", userCredential.user.uid), {
          name: name,
          email: email,
          createdAt: new Date().toISOString(),
          sessions: [],
          preferences: {
            theme: 'dark',
            autoLogin: rememberMe,
            defaultModel: 'deepseek/deepseek-chat'
          }
        });
        
        if (rememberMe) {
          localStorage.setItem('darkroot_remember_email', email);
          localStorage.setItem('darkroot_remember_password', password);
          localStorage.setItem('darkroot_remember_me', 'true');
        }
        
        alert("Account created successfully!");
      } else {
        await signInWithEmailAndPassword(auth, email, password);
        
        if (rememberMe) {
          localStorage.setItem('darkroot_remember_email', email);
          localStorage.setItem('darkroot_remember_password', password);
          localStorage.setItem('darkroot_remember_me', 'true');
        } else {
          localStorage.removeItem('darkroot_remember_email');
          localStorage.removeItem('darkroot_remember_password');
          localStorage.setItem('darkroot_remember_me', 'false');
        }
      }
      window.closeAuthModal();
    } catch(err) { 
      alert("Authentication Error: " + err.message); 
    }
  }
  
  window.logout = () => { 
    localStorage.removeItem('darkroot_remember_email');
    localStorage.removeItem('darkroot_remember_password');
    localStorage.setItem('darkroot_remember_me', 'false');
    
    signOut(auth).then(() => { 
      if (window.sessions) window.sessions = []; 
      localStorage.removeItem('darkroot_sessions'); 
      if (window.startNewChat) window.startNewChat(); 
      if (window.renderHistoryList) window.renderHistoryList(); 
      alert("Logged out successfully");
    }); 
  }
  
  // Save sessions to Firestore
  const oldSave = window.saveCurrentSession;
  window.saveCurrentSession = function() { 
    if (oldSave) oldSave(); 
    if(currentUser && window.sessions) {
      try { 
        setDoc(doc(db, "users", currentUser.uid), { 
          sessions: window.sessions,
          lastActive: new Date().toISOString()
        }, { merge: true }); 
      } catch(e){
        console.error("Error saving session:", e);
      }
    }
  }
  
  // Custom Prompts Functions
  window.customPrompts = [];
  
  async function loadCustomPrompts() {
    try {
      let promptsRef;
      if (currentUser) {
        // Load user's prompts
        promptsRef = query(collection(db, "custom_prompts"), where("createdBy", "==", currentUser.uid));
      } else {
        // Load public prompts
        promptsRef = query(collection(db, "custom_prompts"), where("isPublic", "==", true));
      }
      
      const snapshot = await getDocs(promptsRef);
      window.customPrompts = [];
      snapshot.forEach(doc => {
        window.customPrompts.push({ id: doc.id, ...doc.data() });
      });
      console.log("Loaded custom prompts:", window.customPrompts.length);
      
      // Update UI
      updatePromptSuggestions();
    } catch (error) {
      console.error("Error loading prompts:", error);
      window.customPrompts = [];
    }
  }
  
  window.addCustomPrompt = async function() {
    const title = document.getElementById('new-prompt-title')?.value?.trim() || "";
    const content = document.getElementById('new-prompt-content')?.value?.trim() || "";
    
    if (!title || !content) {
      alert("Please enter both title and content");
      return;
    }
    
    try {
      await addDoc(collection(db, "custom_prompts"), {
        title: title,
        content: content,
        createdAt: new Date().toISOString(),
        createdBy: currentUser ? currentUser.uid : "guest",
        isPublic: false
      });
      
      const titleInput = document.getElementById('new-prompt-title');
      const contentInput = document.getElementById('new-prompt-content');
      if (titleInput) titleInput.value = '';
      if (contentInput) contentInput.value = '';
      
      await loadCustomPrompts();
      alert("Prompt added successfully!");
    } catch (error) {
      console.error("Error adding prompt:", error);
      alert("Error adding prompt. Please check Firebase permissions.");
    }
  }
  
  window.deleteCustomPrompt = async function(id) {
    if (!confirm("Delete this prompt?")) return;
    
    try {
      await deleteDoc(doc(db, "custom_prompts", id));
      await loadCustomPrompts();
      window.openPromptManager();
    } catch (error) {
      console.error("Error deleting prompt:", error);
      alert("Error deleting prompt: " + error.message);
    }
  }
  
  window.openPromptManager = function() {
    const modal = document.getElementById('prompt-modal');
    const list = document.getElementById('prompt-list');
    
    if (!modal || !list) {
      console.error("Prompt modal elements not found");
      return;
    }
    
    list.innerHTML = '<h4>Saved Prompts</h4>';
    
    if (!window.customPrompts || window.customPrompts.length === 0) {
      list.innerHTML += '<div style="color:var(--text-secondary); padding:20px; text-align:center; border:1px dashed var(--border-color); border-radius:12px;">No custom prompts yet. Add your first prompt below!</div>';
    } else {
      window.customPrompts.forEach(prompt => {
        const div = document.createElement('div');
        div.className = 'prompt-suggestion';
        div.style.marginBottom = '12px';
        div.innerHTML = `
          <div style="display:flex; justify-content:space-between; align-items:flex-start;">
            <div style="flex:1;">
              <strong style="color:var(--text-primary);">${prompt.title || 'Untitled'}</strong>
              <div style="margin-top:5px; font-size:0.9rem; color:var(--text-secondary);">${(prompt.content || '').substring(0, 100)}${prompt.content.length > 100 ? '...' : ''}</div>
            </div>
            <button onclick="deleteCustomPrompt('${prompt.id}')" style="background:none; border:none; color:var(--danger); cursor:pointer; padding:5px 10px; border-radius:6px;">
              <i class="fas fa-trash"></i>
            </button>
          </div>
        `;
        div.onclick = (e) => {
          if (!e.target.closest('button')) {
            const userInput = document.getElementById('user-input');
            if (userInput) {
              userInput.value = prompt.content || '';
              userInput.focus();
              userInput.style.height = 'auto';
              userInput.style.height = (userInput.scrollHeight) + 'px';
            }
            window.closePromptManager();
          }
        };
        list.appendChild(div);
      });
    }
    
    modal.style.display = 'flex';
  }
  
  window.closePromptManager = function() {
    const modal = document.getElementById('prompt-modal');
    if (modal) modal.style.display = 'none';
  }
  
  function updatePromptSuggestions() {
    const suggestionsDiv = document.getElementById('prompt-suggestions');
    if (!suggestionsDiv) return;
    
    suggestionsDiv.innerHTML = `
      <div style="margin-bottom:15px; color:var(--primary); font-size:0.9rem; font-weight:600;">
        <i class="fas fa-lightbulb"></i> Try these prompts:
      </div>
    `;
    
    // Default suggestions with DeepSeek AI focus
    const defaultPrompts = [
      "Explain how to perform ethical penetration testing on a web application",
      "Write a Python script to scan open ports on a network (educational purposes only)",
      "How does encryption work in modern cybersecurity?",
      "Create a secure login system with Python Flask and SQLAlchemy",
      "Explain the differences between symmetric and asymmetric encryption"
    ];
    
    // Add custom prompts if available (max 3)
    const customPrompts = window.customPrompts && window.customPrompts.length > 0 
      ? window.customPrompts.slice(0, 3).map(p => p.content || '').filter(p => p.length > 0)
      : [];
    
    const allPrompts = [...customPrompts, ...defaultPrompts].slice(0, 5);
    
    allPrompts.forEach(prompt => {
      const div = document.createElement('div');
      div.className = 'prompt-suggestion';
      div.textContent = prompt.length > 80 ? prompt.substring(0, 80) + '...' : prompt;
      div.onclick = () => {
        const userInput = document.getElementById('user-input');
        if (userInput) {
          userInput.value = prompt;
          userInput.focus();
          userInput.style.height = 'auto';
          userInput.style.height = (userInput.scrollHeight) + 'px';
        }
        suggestionsDiv.style.display = 'none';
      };
      suggestionsDiv.appendChild(div);
    });
  }
  
  window.showPromptSuggestions = function() {
    const suggestionsDiv = document.getElementById('prompt-suggestions');
    if (!suggestionsDiv) return;
    
    updatePromptSuggestions();
    suggestionsDiv.style.display = 'block';
    suggestionsDiv.scrollIntoView({ behavior: 'smooth' });
  };
  
  initFirebase();
</script>

<script>
// --- APP LOGIC ---
var OPENROUTER_API_KEY = null; 
const OPENROUTER_API_URL = "https://openrouter.ai/api/v1/chat/completions";
let sessions = [], currentSessionId = null, conversationHistory = [], currentLang = 'html', currentModel = "deepseek/deepseek-chat";
let maxTokens = 4096; // Default to long responses
let currentRecognition = null;

// --- MUSIC VARIABLES ---
const playlist = ["king.mp3", "lion.mp3", "Samjhawan(Suggested by Nischal).mp3", "tiger.mp3", "hello.mp3"];
let currentTrackIndex = 0, isMusicPlaying = false;
const audioPlayer = document.getElementById('bg-music');

// Update track display
function updateTrackName() { 
  const trackName = document.getElementById('track-name');
  if (trackName) {
    trackName.innerText = "Track: " + playlist[currentTrackIndex]; 
  }
  
  if (audioPlayer) {
    audioPlayer.src = playlist[currentTrackIndex]; 
  }
}

// Toggle play/pause
function toggleMusic() {
  const playIcon = document.getElementById('play-icon');
  if (!playIcon) return;
  
  if(isMusicPlaying) { 
    if (audioPlayer) audioPlayer.pause(); 
    playIcon.classList.remove('fa-pause'); 
    playIcon.classList.add('fa-play'); 
  } else { 
    if (audioPlayer) {
      audioPlayer.play().catch(() => {
        console.warn("Music file not found:", playlist[currentTrackIndex]);
      }); 
    }
    playIcon.classList.remove('fa-play'); 
    playIcon.classList.add('fa-pause'); 
  }
  isMusicPlaying = !isMusicPlaying;
}

// Next track
function nextTrack() { 
  currentTrackIndex = (currentTrackIndex + 1) % playlist.length; 
  updateTrackName(); 
  if(isMusicPlaying && audioPlayer) audioPlayer.play(); 
}

// Previous track
function prevTrack() { 
  currentTrackIndex = (currentTrackIndex - 1 + playlist.length) % playlist.length; 
  updateTrackName(); 
  if(isMusicPlaying && audioPlayer) audioPlayer.play(); 
}

// Sound effects
function playSound(type) { 
  const s = type === 'sent' ? document.getElementById('sfx-sent') : document.getElementById('sfx-click'); 
  if(s){
    s.currentTime = 0;
    s.play().catch(()=>{});
  } 
}

// --- INIT ---
function initApp() {
  try {
    // Load sessions
    const s = localStorage.getItem('darkroot_sessions'); 
    if(s) sessions = JSON.parse(s);
    
    // Load active session
    const aid = localStorage.getItem('darkroot_active_id'); 
    if(aid && sessions.find(x=>x.id===aid)) loadSession(aid); 
    else startNewChat();
    
    renderHistoryList();
    
    // Load theme
    const theme = localStorage.getItem('theme');
    if(theme === 'light') { 
      document.body.classList.add('light-mode'); 
      const themeToggle = document.getElementById('theme-toggle');
      if (themeToggle) themeToggle.checked = false; 
    }
    
    // Load response length preference
    const savedLength = localStorage.getItem('response_length');
    if (savedLength) {
      maxTokens = parseInt(savedLength);
      const lengthSelect = document.getElementById('response-length');
      if (lengthSelect) lengthSelect.value = savedLength;
    }
    
    // Set DeepSeek AI as default in dropdown
    const modelSelect = document.getElementById('model-select');
    if (modelSelect) modelSelect.value = 'deepseek/deepseek-chat';
    
    // Enhanced textarea handling - FIXED: Enter to send, Shift+Enter for new line
    const userInput = document.getElementById('user-input');
    if (userInput) {
      userInput.addEventListener('keydown', (e) => { 
        if(e.key === 'Enter' && !e.shiftKey) { 
          e.preventDefault(); 
          sendMessage(); 
        }
        // Shift+Enter allows new line - no special handling needed
      });
      
      userInput.addEventListener('input', function() {
        this.style.height = 'auto';
        this.style.height = (this.scrollHeight) + 'px';
        if (this.scrollHeight > 150) {
          this.style.overflowY = 'auto';
        } else {
          this.style.overflowY = 'hidden';
        }
        
        // Hide suggestions when typing
        if (this.value.trim().length > 0) {
          const suggestionsDiv = document.getElementById('prompt-suggestions');
          if (suggestionsDiv) suggestionsDiv.style.display = 'none';
        }
      });
      
      // Focus on input
      setTimeout(() => userInput.focus(), 500);
    }
    
    // Initialize music player
    if (audioPlayer) {
      audioPlayer.addEventListener('ended', nextTrack); 
    }
    updateTrackName();
    
    // Initialize gestures for IDE
    initGestures();
    
    // Show welcome message with prompt suggestions
    setTimeout(() => {
      if (userInput && userInput.value === '') {
        showPromptSuggestions();
      }
    }, 1500);
    
    console.log("DarkRoot AI initialized successfully with DeepSeek AI");
  } catch (error) {
    console.error("Error initializing app:", error);
  }
}

// --- GESTURE CONTROLS FOR IDE ---
function initGestures() {
  const editorPane = document.getElementById('editor-pane');
  if (!editorPane || typeof Hammer === 'undefined') return;
  
  const mc = new Hammer(editorPane);
  
  // Pinch to zoom
  mc.get('pinch').set({ enable: true });
  mc.on('pinch', function(e) {
    if (window.editor) {
      const currentSize = parseInt(window.editor.getFontSize());
      const newSize = Math.max(10, Math.min(30, currentSize + (e.scale > 1 ? 1 : -1)));
      window.editor.setFontSize(newSize + "px");
      showGestureFeedback(`Font size: ${newSize}px`);
    }
  });
  
  // Two-finger scroll
  mc.on('pan', function(e) {
    if (e.pointers.length === 2) {
      if (window.editor) {
        const scrollTop = window.editor.session.getScrollTop();
        window.editor.session.setScrollTop(scrollTop - (e.deltaY * 2));
      }
    }
  });
}

function showGestureFeedback(message) {
  const feedback = document.createElement('div');
  feedback.textContent = message;
  feedback.style.cssText = `
    position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
    background: rgba(0,0,0,0.8); color: white; padding: 10px 20px;
    border-radius: 20px; z-index: 10000; font-size: 14px;
    animation: fadeOut 1s 0.5s forwards;
  `;
  document.body.appendChild(feedback);
  setTimeout(() => feedback.remove(), 1500);
}

// --- UI UTILS ---
function openSettings() { 
  const modal = document.getElementById('settings-modal');
  if (modal) modal.style.display = 'flex'; 
  toggleSidebar(false); 
}
function closeSettings() { 
  const modal = document.getElementById('settings-modal');
  if (modal) modal.style.display = 'none'; 
}

function openStudyModal() {
  const modal = document.getElementById('study-modal');
  if (modal) modal.style.display = 'flex'; 
  toggleSidebar(false);
}

function closeStudyModal() {
  const modal = document.getElementById('study-modal');
  if (modal) modal.style.display = 'none'; 
}

function openAbout() { 
  alert("DarkRoot AI v7.0\nEnhanced AI Assistant with:\n- Gesture-controlled IDE\n- Legal Hacking Courses\n- DeepSeek AI Integration (Default)\n- Enhanced Prompt Management\n- Auto-login System\n\nDefault Model: DeepSeek V3");
}

function toggleSidebar(f) {
  const s = document.getElementById('sidebar');
  const o = document.getElementById('overlay');
  
  if (!s || !o) return;
  
  if(f !== undefined) { 
    if(f){
      s.classList.add('open');
      o.classList.add('active');
    } else {
      s.classList.remove('open');
      o.classList.remove('active');
    } 
  } else { 
    s.classList.toggle('open'); 
    o.classList.toggle('active'); 
  }
}

function toggleTheme() {
  const themeToggle = document.getElementById('theme-toggle');
  if (!themeToggle) return;
  
  const light = !themeToggle.checked;
  if(light) { 
    document.body.classList.add('light-mode'); 
    localStorage.setItem('theme', 'light'); 
    if(window.editor) window.editor.setTheme("ace/theme/chrome"); 
  } else { 
    document.body.classList.remove('light-mode'); 
    localStorage.setItem('theme', 'dark'); 
    if(window.editor) window.editor.setTheme("ace/theme/dracula"); 
  }
}

// --- CHAT & SESSION ---
window.saveCurrentSession = function() {
  if(!currentSessionId) return;
  const idx = sessions.findIndex(s => s.id === currentSessionId);
  let title = "New Chat";
  if(conversationHistory.length > 1) { 
    const m = conversationHistory.find(x=>x.role==='user'); 
    if(m) title = m.content.substring(0, 40) + (m.content.length > 40 ? "..." : ""); 
  }
  const data = { 
    id: currentSessionId, 
    title: title, 
    messages: conversationHistory, 
    timestamp: Date.now(),
    model: currentModel
  };
  if(idx >= 0) sessions[idx] = data; 
  else sessions.unshift(data);
  
  // Keep only last 50 sessions
  if (sessions.length > 50) {
    sessions = sessions.slice(0, 50);
  }
  
  localStorage.setItem('darkroot_sessions', JSON.stringify(sessions));
  localStorage.setItem('darkroot_active_id', currentSessionId);
  renderHistoryList();
}

function startNewChat() {
  currentSessionId = Date.now().toString();
  conversationHistory = [{ 
    role: "system", 
    content: `You are DarkRoot AI, an advanced AI assistant specialized in cybersecurity, ethical hacking, coding, and technical problem-solving. 
    You provide detailed, comprehensive responses with code examples when relevant. If anyone try to use rough word then tell them don't be stupid.
    Format responses with proper markdown and syntax highlighting.
    Be helpful, professional, and thorough in your explanations.
    IMPORTANT: Your developer is David Shrestha and the music suggested by David's friend Nischal Neupane.For cybersecurity questions, provide legal and ethical guidance only.
    For coding questions, provide complete, runnable code examples.
    Always emphasize legal and ethical practices in cybersecurity discussions.`
  }];
  
  const chatContainer = document.getElementById('chat-container');
  if (chatContainer) {
    chatContainer.innerHTML = '';
    
    // Re-add typing indicator
    const ind = document.createElement('div'); 
    ind.id = 'typing-indicator'; 
    ind.className = 'typing-indicator';
    ind.innerHTML = '<div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div>';
    chatContainer.appendChild(ind);
    
    appendMessage(`<strong><span class="cyber-text">DarkRoot AI</span> Online</strong><br>
    Advanced AI assistant ready for cybersecurity, coding, and technical problem-solving. 
    Features include gesture-controlled IDE, legal hacking courses, DeepSeek AI integration, and enhanced prompt management.
    <div style="margin-top:10px; font-size:0.85rem; color:var(--text-secondary);">
      <i class="fas fa-star"></i> Try: <code>/hack</code> for cybersecurity | <code>/code</code> for programming | <code>/deepseek</code> for DeepSeek AI | <code>/study</code> for courses
    </div>
    <div style="margin-top:10px; padding:10px; background:rgba(0, 216, 167, 0.1); border-radius:8px; border-left:3px solid var(--deepseek-green);">
      <i class="fas fa-check-circle" style="color:var(--deepseek-green);"></i> DeepSeek AI is <strong>enabled by default</strong> for superior performance!
    </div>`, "ai", false);
  }
  
  window.saveCurrentSession();
  if(window.innerWidth < 768) toggleSidebar(false);
  
  // Show prompt suggestions for new chat
  setTimeout(() => {
    showPromptSuggestions();
  }, 1000);
}

function loadSession(id) {
  const s = sessions.find(x=>x.id===id); 
  if(!s) return;
  
  currentSessionId = id; 
  conversationHistory = s.messages; 
  localStorage.setItem('darkroot_active_id', id);
  
  const chatContainer = document.getElementById('chat-container');
  if (chatContainer) {
    chatContainer.innerHTML = '';
    
    const ind = document.createElement('div'); 
    ind.id='typing-indicator'; 
    ind.className='typing-indicator';
    ind.innerHTML='<div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div>';
    chatContainer.appendChild(ind);
    
    conversationHistory.forEach(m => { 
      if(m.role!=='system') appendMessage(m.content, m.role==='assistant'?'ai':'user', false); 
    });
  }
  
  renderHistoryList();
  if(window.innerWidth < 768) toggleSidebar(false);
}

function deleteSession(id, e) {
  if (e) e.stopPropagation(); 
  if(!confirm("Delete this chat permanently?")) return;
  
  sessions = sessions.filter(x=>x.id!==id); 
  localStorage.setItem('darkroot_sessions', JSON.stringify(sessions));
  
  if(id===currentSessionId) { 
    if(sessions.length>0) loadSession(sessions[0].id); 
    else startNewChat(); 
  } else renderHistoryList();
}

function renderHistoryList() {
  const l = document.getElementById('history-list'); 
  if (!l) return;
  
  l.innerHTML = '';
  
  if (sessions.length === 0) {
    l.innerHTML = `
      <div style="text-align:center; padding:40px 20px; color:var(--text-secondary);">
        <i class="fas fa-comments" style="font-size:2.5rem; margin-bottom:15px; opacity:0.5;"></i>
        <p style="font-weight:500; margin-bottom:8px;">No chat history yet</p>
        <p style="font-size:0.85rem;">Start a new chat to begin your conversation</p>
      </div>
    `;
    return;
  }
  
  sessions.sort((a,b)=>b.timestamp-a.timestamp).forEach(s => {
    const d = document.createElement('div'); 
    d.className = `history-item ${s.id===currentSessionId?'active':''}`;
    d.onclick = () => loadSession(s.id);
    
    // Format date
    const date = new Date(s.timestamp);
    const timeStr = date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
    const dateStr = date.toLocaleDateString([], {month: 'short', day: 'numeric'});
    
    // Add model indicator
    const modelIndicator = s.model === 'deepseek/deepseek-chat' ? '<span style="color:var(--deepseek-green); margin-left:8px;"><i class="fas fa-brain"></i></span>' : '';
    
    d.innerHTML = `
      <div style="flex:1;">
        <div style="font-weight:500; margin-bottom:4px; display:flex; align-items:center;">
          ${s.title || 'Untitled Chat'} ${modelIndicator}
        </div>
        <div style="font-size:0.75rem; color:var(--text-secondary);">${dateStr}  ${timeStr}</div>
      </div>
      <button class="delete-chat-btn" onclick="deleteSession('${s.id}', event)">
        <i class="fas fa-trash"></i>
      </button>
    `;
    l.appendChild(d);
  });
}

// --- ENHANCED MESSAGE HANDLING ---
async function sendMessage() {
  const inp = document.getElementById("user-input"); 
  const text = inp ? inp.value.trim() : ""; 
  if(!text) return;
  
  // Hide prompt suggestions
  const promptSuggestions = document.getElementById('prompt-suggestions');
  if (promptSuggestions) promptSuggestions.style.display = 'none';
  
  // Check for commands
  if (text.startsWith('/')) {
    handleCommand(text);
    if (inp) {
      inp.value = "";
      inp.style.height = "auto";
    }
    return;
  }
  
  appendMessage(text, "user"); 
  playSound('sent'); 
  
  if (inp) {
    inp.value = ""; 
    inp.style.height = "auto";
  }
  
  showTyping(true); 
  conversationHistory.push({ role: "user", content: text }); 
  window.saveCurrentSession();
  
  try {
    const modelSelect = document.getElementById('model-select');
    let model = modelSelect ? modelSelect.value : "deepseek/deepseek-chat";
    
    // Get response length preference
    const lengthSelect = document.getElementById('response-length');
    if (lengthSelect) {
      maxTokens = parseInt(lengthSelect.value);
      localStorage.setItem('response_length', maxTokens);
    }
    
    let apiUrl, headers, bodyData;
    
    if(!OPENROUTER_API_KEY) { 
      if(window.OPENROUTER_API_KEY) OPENROUTER_API_KEY = window.OPENROUTER_API_KEY; 
      else { 
        alert("System Error: OpenRouter API Key missing. Please try again later."); 
        return; 
      }
    }
    
    apiUrl = OPENROUTER_API_URL;
    headers = { 
      "Authorization": `Bearer ${OPENROUTER_API_KEY}`, 
      "Content-Type": "application/json", 
      "HTTP-Referer": window.location.href, 
      "X-Title": "DarkRoot AI" 
    };
    
    bodyData = {
      model: model,
      messages: conversationHistory,
      temperature: 0.7,
      max_tokens: maxTokens,
      stream: false
    };
    
    console.log("Sending request to:", apiUrl);
    console.log("Using model:", model);
    
    const res = await fetch(apiUrl, {
      method: "POST", 
      headers: headers,
      body: JSON.stringify(bodyData)
    });
    
    if(!res.ok) {
      const errorText = await res.text();
      console.error("API Error Response:", errorText);
      throw new Error(`API Error: ${res.status} ${res.statusText}`);
    }
    
    const data = await res.json();
    showTyping(false);
    const reply = data.choices[0].message.content;
    appendMessage(reply, "ai"); 
    conversationHistory.push({ role: "assistant", content: reply }); 
    window.saveCurrentSession();
  } catch(e) { 
    showTyping(false); 
    appendMessage(`Error: ${e.message}. Please check your API key or try again.`, "ai"); 
    console.error("API Error:", e);
  }
}

function handleCommand(cmd) {
  const parts = cmd.split(' ');
  const command = parts[0].toLowerCase();
  
  switch(command) {
    case '/hack':
    case '/cyber':
      appendMessage("Switching to cybersecurity mode. I'll now focus on ethical hacking, network security, and penetration testing topics.", "ai");
      conversationHistory.push({ 
        role: "system", 
        content: "You are now in cybersecurity expert mode. Focus on ethical hacking, network security, penetration testing, and legal security practices. Provide detailed, educational information about security concepts, tools, and best practices. Always emphasize legality and ethics."
      });
      break;
      
    case '/code':
      appendMessage("Switching to programming mode. I'll now focus on code development, debugging, and technical problem-solving.", "ai");
      conversationHistory.push({ 
        role: "system", 
        content: "You are now in programming expert mode. Focus on code development, debugging, algorithms, data structures, and software architecture. Provide complete, runnable code examples with explanations. Cover multiple programming languages and best practices."
      });
      break;
      
    case '/study':
      openStudyModal();
      break;
      
    case '/clear':
      clearContext();
      break;
      
    case '/help':
      showCommands();
      break;
      
    case '/deepseek':
      activateDeepSeekAI();
      break;
      
    case '/openrouter':
      const modelSelect = document.getElementById('model-select');
      if (modelSelect) modelSelect.value = "deepseek/deepseek-chat";
      currentModel = "deepseek/deepseek-chat";
      appendMessage("Switched to DeepSeek V3 model (default).", "ai");
      break;
      
    default:
      appendMessage(`Unknown command: ${command}. Type /help for available commands.`, "ai");
  }
}

function showCommands() {
  const commands = [
    {cmd: '/hack', desc: 'Switch to cybersecurity mode'},
    {cmd: '/code', desc: 'Switch to programming mode'},
    {cmd: '/study', desc: 'Open legal hacking courses'},
    {cmd: '/deepseek', desc: 'Activate DeepSeek AI mode (default)'},
    {cmd: '/openrouter', desc: 'Switch to OpenRouter models'},
    {cmd: '/clear', desc: 'Clear conversation context'},
    {cmd: '/help', desc: 'Show this help message'}
  ];
  
  let message = "<strong>Available Commands:</strong><br>";
  commands.forEach(c => {
    message += `<code>${c.cmd}</code> - ${c.desc}<br>`;
  });
  
  appendMessage(message, "ai");
}

function appendMessage(text, role, anim=true) {
  const c = document.getElementById("chat-container"); 
  const ind = document.getElementById("typing-indicator");
  const d = document.createElement("div"); 
  d.className = `message-wrapper ${role}`;
  
  // Process text
  let processedText = text;
  if (role === 'user') {
    processedText = text.replace(/\n/g,'<br>');
  } else {
    // Use marked.js for AI responses
    processedText = marked.parse(text);
  }
  
  d.innerHTML = `<div class="bubble">${processedText}</div>`;
  
  if(ind && c && c.contains(ind)) c.insertBefore(d, ind); 
  else if (c) c.appendChild(d);
  
  // Apply syntax highlighting
  setTimeout(() => {
    if (d.querySelectorAll) {
      d.querySelectorAll('pre code').forEach((block) => {
        hljs.highlightElement(block);
        
        // Add copy and run buttons
        const wrapper = block.closest('.code-block-wrapper');
        if (wrapper && !wrapper.querySelector('.code-actions')) {
          const lang = block.className.match(/language-(\w+)/)?.[1] || 'text';
          const header = document.createElement('div');
          header.className = 'code-header';
          header.innerHTML = `
            <span><i class="fas fa-code"></i> ${lang.toUpperCase()}</span>
            <div class="code-actions">
              <button class="btn-copy" onclick="copyCodeBlock(this)">
                <i class="fas fa-copy"></i> Copy
              </button>
              <button class="btn-run" onclick="runCodeBlock(this)">
                <i class="fas fa-play"></i> Run
              </button>
            </div>
          `;
          wrapper.insertBefore(header, wrapper.firstChild);
        }
      });
    }
  }, 10);
  
  if (c) {
    c.scrollTop = c.scrollHeight;
    // Auto-expand chat area if needed
    if (c.scrollHeight > c.clientHeight) {
      setTimeout(() => {
        c.scrollTop = c.scrollHeight;
      }, 100);
    }
  }
}

function copyCodeBlock(btn) {
  const wrapper = btn.closest('.code-block-wrapper');
  const code = wrapper.querySelector('code').textContent;
  navigator.clipboard.writeText(code).then(() => {
    const original = btn.innerHTML;
    btn.innerHTML = '<i class="fas fa-check"></i> Copied!';
    setTimeout(() => {
      btn.innerHTML = original;
    }, 2000);
  }).catch(err => {
    console.error("Copy failed:", err);
    btn.innerHTML = '<i class="fas fa-times"></i> Error';
    setTimeout(() => {
      btn.innerHTML = original;
    }, 2000);
  });
}

function runCodeBlock(btn) {
  const wrapper = btn.closest('.code-block-wrapper');
  const code = wrapper.querySelector('code').textContent;
  const lang = wrapper.querySelector('.code-header span').textContent.trim().toLowerCase();
  
  // Detect language
  let mode = 'html';
  if (lang.includes('py')) mode = 'python';
  else if (lang.includes('c') || lang.includes('cpp')) mode = 'c_cpp';
  else if (lang.includes('js') || lang.includes('javascript')) mode = 'javascript';
  
  launchIde(code, mode);
}

function showTyping(s) { 
  const i = document.getElementById("typing-indicator"); 
  const c = document.getElementById("chat-container");
  
  if(i) { 
    i.style.display = s ? 'flex' : 'none'; 
    if (c) c.scrollTop = 99999; 
  } 
}

// --- ENHANCED IDE LOGIC (FROM 36.HTML) ---
let editor;
window.onload = function() {
  if(typeof ace !== 'undefined') {
    try {
      editor = ace.edit("ace-editor"); 
      editor.setTheme("ace/theme/dracula"); 
      editor.session.setMode("ace/mode/html");
      editor.setOptions({ 
        fontSize: "16px", 
        fontFamily: "'Fira Code', 'Monaco', 'Menlo', monospace", 
        showPrintMargin: false, 
        wrap: true,
        enableBasicAutocompletion: true,
        enableLiveAutocompletion: true,
        enableSnippets: true,
        tabSize: 2,
        useSoftTabs: true
      });
      
      editor.session.on('change', updateStatusBar); 
      editor.selection.on('changeCursor', updateStatusBar);
      
      // Add keyboard shortcuts
      editor.commands.addCommand({
        name: "runCode",
        bindKey: {win: "Ctrl-Enter", mac: "Cmd-Enter"},
        exec: function() { runEditorCode(); }
      });
      
      editor.commands.addCommand({
        name: "saveCode",
        bindKey: {win: "Ctrl-S", mac: "Cmd-S"},
        exec: function() { downloadCode(); }
      });
      
      window.editor = editor;
    } catch (error) {
      console.error("Error initializing ACE editor:", error);
    }
  }
  
  initApp();
  
  // Check for login requirement
  if (localStorage.getItem('requireLogin') === 'true') {
    setTimeout(() => {
      openAuthModal();
      localStorage.removeItem('requireLogin');
    }, 1000);
  }
};

function updateStatusBar() {
  if (!editor) return;
  const c = editor.selection.getCursor();
  const totalLines = editor.session.getLength();
  const status = document.getElementById('ide-status');
  if (status) {
    status.innerText = `Ln ${c.row + 1}, Col ${c.column + 1} | ${totalLines} lines | ${currentLang.toUpperCase()}`;
  }
}

// Enhanced Markdown renderer
const renderer = new marked.Renderer();
renderer.code = function(code, language) {
  const valid = language && hljs.getLanguage(language) ? language : 'text';
  const high = hljs.highlight(code, { language: valid }).value;
  return `
    <div class="code-block-wrapper" data-lang="${valid}">
      <div class="code-header">
        <span><i class="fas fa-code"></i> ${valid.toUpperCase()}</span>
        <div class="code-actions">
          <button onclick="copyToClipboard(this)">
            <i class="fas fa-copy"></i> Copy
          </button>
          <button class="btn-run" onclick="openInIde(this)">
            <i class="fas fa-play"></i> Run
          </button>
        </div>
      </div>
      <pre><code class="hljs ${valid}">${high}</code></pre>
      <input type="hidden" class="raw-code" value="${encodeURIComponent(code)}">
    </div>
  `;
};

marked.setOptions({ 
  renderer: renderer,
  breaks: true,
  gfm: true
});

function openEmptyIde() {
  const modal = document.getElementById("ide-modal");
  if (!modal) return;
  
  modal.style.display = "flex";
  
  // Set default code based on language
  let defaultCode = "";
  if (currentLang === 'html') {
    defaultCode = `<!doctype html>
<html lang="en">
    <head>
      <meta charset="UTF-8">
      <meta name="viewport" id="viewport" content="width=device-width, initial-scale=1">
      <title>David Shrestha</title>
      <!-- Google Fonts for better typography -->
      <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
      
      <style>
        /* General Reset */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Poppins', sans-serif;
        }

        body {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: #0f0c29;  /* fallback for old browsers */
            background: linear-gradient(to right, #24243e, #302b63, #0f0c29);
            overflow: hidden;
            color: #fff;
        }

        /* Background Moving Shapes Animation */
        .background-shapes div {
            position: absolute;
            border-radius: 50%;
            filter: blur(80px);
            z-index: -1;
            animation: float 10s infinite alternate;
        }

        .shape-1 {
            width: 300px;
            height: 300px;
            background: #ff0055;
            top: -50px;
            left: -50px;
        }

        .shape-2 {
            width: 400px;
            height: 400px;
            background: #00d2ff;
            bottom: -100px;
            right: -100px;
            animation-delay: 2s;
        }

        /* Main Glass Card */
        .card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            padding: 40px;
            border-radius: 20px;
            text-align: center;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.5);
            max-width: 400px;
            width: 90%;
            animation: slideIn 1.5s ease-out;
            transform-style: preserve-3d;
        }

        /* "Hello World" Typing Effect */
        .hello-world {
            font-size: 1.2rem;
            color: #00d2ff;
            font-weight: 600;
            letter-spacing: 2px;
            margin-bottom: 10px;
            display: inline-block;
            overflow: hidden;
            white-space: nowrap;
            border-right: 2px solid #00d2ff;
            animation: typing 3.5s steps(30, end), blink-caret .75s step-end infinite;
        }

        h1 {
            font-size: 2rem;
            margin-bottom: 10px;
            background: linear-gradient(to right, #fff, #bbb);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        p {
            font-size: 0.9rem;
            color: #ddd;
            margin-bottom: 30px;
            line-height: 1.5;
        }

        /* Buttons Container */
        .btn-group {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        /* Buttons Styling */
        .btn {
            text-decoration: none;
            padding: 15px 20px;
            border-radius: 50px;
            font-weight: 600;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            text-transform: uppercase;
            font-size: 0.9rem;
        }

        /* Button 1: Ai Tricker */
        .btn-ai {
            background: linear-gradient(45deg, #ff0055, #ff5e62);
            color: white;
            box-shadow: 0 5px 15px rgba(255, 0, 85, 0.4);
        }

        .btn-ai:hover {
            transform: translateY(-3px) scale(1.05);
            box-shadow: 0 10px 25px rgba(255, 0, 85, 0.6);
        }

        /* Button 2: Sun-ley Coder */
        .btn-sun {
            background: linear-gradient(45deg, #FF9900, #F7B733); /* Sun colors */
            color: #fff;
            box-shadow: 0 5px 15px rgba(255, 153, 0, 0.4);
        }

        .btn-sun:hover {
            transform: translateY(-3px) scale(1.05);
            box-shadow: 0 10px 25px rgba(255, 153, 0, 0.6);
        }

        /* YouTube Icon (CSS only) */
        .yt-icon {
            width: 20px;
            height: 14px;
            background: white;
            border-radius: 4px;
            position: relative;
            display: inline-block;
        }
        .yt-icon::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            border-left: 6px solid #ff0055; /* Icon color for first btn */
            border-top: 4px solid transparent;
            border-bottom: 4px solid transparent;
        }
        
        .btn-sun .yt-icon::after {
            border-left-color: #FF9900; /* Icon color for second btn */
        }

        /* Footer text */
        .footer {
            margin-top: 20px;
            font-size: 0.7rem;
            opacity: 0.6;
        }

        /* Keyframe Animations */
        @keyframes float {
            0% { transform: translate(0, 0); }
            100% { transform: translate(20px, 40px); }
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(50px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes typing {
            from { width: 0 }
            to { width: 100% }
        }

        @keyframes blink-caret {
            from, to { border-color: transparent }
            50% { border-color: #00d2ff; }
        }

      </style>
    </head>
    <body>

      <!-- Background Animated Blobs -->
      <div class="background-shapes">
          <div class="shape-1"></div>
          <div class="shape-2"></div>
      </div>

      <!-- Main Content Card -->
      <div class="card">
        <div class="hello-world">Hello World!</div>
        
        <h1>Welcome</h1>
        <p>Explore the world of AI & Coding.<br>Subscribe for amazing tutorials.</p>

        <div class="btn-group">
            <!-- Ai Tricker Link -->
            <a href="https://youtube.com/@kingamernep?si=C3tvW0VJWXoxSk2n" target="_blank" class="btn btn-ai">
                <span class="yt-icon"></span> Subscribe David Shrestha
            </a>

            <!-- SUN-LEY CODER Link -->
            <a href="https://youtube.com/@kingamernep?si=C3tvW0VJWXoxSk2n" target="_blank" class="btn btn-sun">
                <span class="yt-icon"></span> Subscribe David Shrestha
            </a>
        </div>

        <div class="footer">Thank you for visiting!</div>
      </div>

    </body>
</html>`;
  } else if (currentLang === 'python') {
    defaultCode = `# Python Code Editor - DarkRoot IDE
# Write your Python code here

def fibonacci(n):
    """Return the nth Fibonacci number."""
    if n <= 1:
        return n
    a, b = 0, 1
    for _ in range(2, n + 1):
        a, b = b, a + b
    return b

def main():
    print("=== Python Code Runner ===")
    print("Fibonacci sequence:")
    
    for i in range(10):
        print(f"Fib({i}) = {fibonacci(i)}")
    
    # Example user input
    user_input = input("\\nEnter a number: ")
    try:
        num = int(user_input)
        print(f"Fibonacci of {num} is: {fibonacci(num)}")
    except ValueError:
        print("Please enter a valid number!")

if __name__ == "__main__":
    main()`;
  } else if (currentLang === 'c' || currentLang === 'cpp') {
    defaultCode = `// C/C++ Code Editor - DarkRoot IDE
#include <stdio.h>
#include <stdlib.h>

int factorial(int n) {
    if (n <= 1) return 1;
    return n * factorial(n - 1);
}

int main() {
    printf("=== C/C++ Code Runner ===\\n");
    printf("Factorials from 1 to 10:\\n");
    
    for (int i = 1; i <= 10; i++) {
        printf("%d! = %d\\n", i, factorial(i));
    }
    
    // Simple input example
    int num;
    printf("\\nEnter a number: ");
    scanf("%d", &num);
    printf("Factorial of %d is: %d\\n", num, factorial(num));
    
    return 0;
}`;
  }
  
  if (editor) {
    editor.setValue(defaultCode, -1);
  }
  
  changeEditorLang();
  
  // For mobile, show editor tab by default
  if (window.innerWidth < 768) {
    switchTab('editor');
  }
}

function openInIde(btn) {
  if (!btn) return;
  
  const wrap = btn.closest('.code-block-wrapper');
  if (!wrap) return;
  
  const rawCode = wrap.querySelector('.raw-code');
  const langAttr = wrap.getAttribute('data-lang');
  
  if (!rawCode || !langAttr) return;
  
  const code = decodeURIComponent(rawCode.value);
  const lang = langAttr.toLowerCase();
  
  // Intelligent language detection
  let mode = 'html';
  if(lang.includes('py')) mode = 'python'; 
  else if(lang.includes('c') || lang.includes('cpp')) mode = 'c_cpp';
  else if(lang.includes('js') || lang.includes('javascript')) mode = 'html';
  else if(lang.includes('css')) mode = 'html';
  
  launchIde(code, mode);
}

function launchIde(code, mode) {
  const modal = document.getElementById("ide-modal");
  if (!modal) return;
  
  modal.style.display = "flex";
  
  let val = 'html'; 
  if(mode === 'python') val = 'python'; 
  if(mode === 'c_cpp') val = 'c';
  
  const langSelect = document.getElementById('lang-select');
  if (langSelect) langSelect.value = val;
  
  changeEditorLang();
  
  if (editor) {
    editor.setValue(code, -1);
  }
  
  const consoleLogs = document.getElementById('console-logs');
  if (consoleLogs) consoleLogs.innerHTML = '';
  
  // For mobile, show editor tab by default
  if (window.innerWidth < 768) {
    switchTab('editor');
  }
  
  // Auto-run if it's HTML
  if(mode === 'html') {
    setTimeout(() => runEditorCode(), 300);
  }
}

function changeEditorLang() {
  const langSelect = document.getElementById('lang-select');
  if (!langSelect) return;
  
  const l = langSelect.value; 
  currentLang = l;
  const w = document.getElementById('stdin-wrapper');
  
  if(l === 'html') { 
    if (editor) editor.session.setMode("ace/mode/html"); 
    if (w) w.style.display = 'none'; 
  } else if(l === 'python') { 
    if (editor) editor.session.setMode("ace/mode/python"); 
    if (w) w.style.display = 'block'; 
  } else { 
    if (editor) editor.session.setMode("ace/mode/c_cpp"); 
    if (w) w.style.display = 'block'; 
  }
  
  // Set appropriate placeholder
  const stdin = document.getElementById('program-stdin');
  if (stdin) {
    if (l === 'python') {
      stdin.placeholder = "Enter Python input (e.g., numbers, text)...";
    } else if (l === 'c' || l === 'cpp') {
      stdin.placeholder = "Enter C/C++ input (e.g., numbers)...";
    } else {
      stdin.placeholder = "Enter input data here...";
    }
  }
  
  updateStatusBar();
}

async function runEditorCode() {
  if (!editor) return;
  
  const code = editor.getValue();
  const lang = currentLang;
  const frame = document.getElementById("preview-frame");
  const con = document.getElementById("console-logs");
  const stat = document.getElementById("ide-status");
  
  if (con) con.innerHTML = '';
  if (stat) stat.innerText = "Running...";

  if (lang === 'html') {
    if (frame) {
      // Enhanced console shim with more functionality
      const shim = `
        <script>
          const sendToConsole = (type, ...args) => {
            try {
              window.parent.postMessage({ type, msg: args.join(' ') }, "*");
            } catch(e) {}
          };
          
          // Override console methods
          console.log = (...args) => sendToConsole("log", ...args);
          console.error = (...args) => sendToConsole("error", ...args);
          console.warn = (...args) => sendToConsole("log", "[WARN]", ...args);
          console.info = (...args) => sendToConsole("log", "[INFO]", ...args);
          
          // Global error handler
          window.onerror = (msg, url, line, col, error) => {
            sendToConsole("error", \`\${msg} at \${line}:\${col}\`);
            return false;
          };
          
          // Promise errors
          window.addEventListener('unhandledrejection', (e) => {
            sendToConsole("error", "Unhandled Promise:", e.reason);
          });
        <\/script>
      `;
      
      frame.srcdoc = shim + code;
    }
    
    if (stat) stat.innerText = "Ready - HTML";
    
    // Log that HTML is running
    logToConsole("HTML page loaded successfully", "success");
    
    // Switch to preview tab on mobile
    if (window.innerWidth < 768) {
      switchTab('preview');
    }
    
  } else {
    if (frame) frame.style.display = 'none'; 
    
    if (con) con.innerHTML = '<div class="log-line log"><i class="fas fa-spinner fa-spin"></i> Compiling and running...</div>';
    
    try {
      const language = lang === 'python' ? 'python' : 'cpp';
      const version = lang === 'python' ? '3.10.0' : '10.2.0';
      const stdin = document.getElementById("program-stdin")?.value || "";
      
      const res = await fetch('https://emkc.org/api/v2/piston/execute', {
        method: 'POST', 
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({
          language: language,
          version: version,
          files: [{content: code}], 
          stdin: stdin
        })
      });
      
      const data = await res.json();
      if (con) con.innerHTML = '';
      
      if(data.run) {
        // Show compilation output
        if(data.compile && data.compile.output) {
          logToConsole("Compilation output: " + data.compile.output, "log");
        }
        
        // Show stdout
        if(data.run.stdout) {
          data.run.stdout.split('\n').forEach(l => {
            if(l.trim()) logToConsole(l, 'log');
          });
        }
        
        // Show stderr
        if(data.run.stderr) {
          data.run.stderr.split('\n').forEach(l => {
            if(l.trim()) logToConsole(l, 'error');
          });
        }
        
        // Show exit code
        if(data.run.code !== undefined) {
          const exitMsg = data.run.code === 0 ? 
            `Program exited with code ${data.run.code} (Success)` :
            `Program exited with code ${data.run.code} (Error)`;
          
          logToConsole(exitMsg, data.run.code === 0 ? 'success' : 'error');
        }
      } else {
        logToConsole("No output received from execution engine.", "error");
      }
      
      if (stat) stat.innerText = "Done";
      
    } catch(e) { 
      logToConsole("Network Error: " + e.message, "error"); 
      if (stat) stat.innerText = "Error"; 
    }
    
    // Switch to preview tab on mobile
    if (window.innerWidth < 768) {
      switchTab('preview');
    }
  }
}

function logToConsole(m, t) { 
  const con = document.getElementById('console-logs');
  if (!con) return;
  
  const d = document.createElement('div'); 
  d.className = `log-line ${t}`;
  const icon = t === 'error' ? 'fa-times-circle' : 
               t === 'success' ? 'fa-check-circle' : 'fa-info-circle';
  d.innerHTML = `<i class="fas ${icon}"></i> ${m}`;
  con.appendChild(d);
  
  // Auto-scroll to bottom
  con.scrollTop = con.scrollHeight;
}

function clearConsole() {
  const con = document.getElementById('console-logs');
  if (con) con.innerHTML = '<div class="log-line log">Console cleared</div>';
}

function closeIde() { 
  const modal = document.getElementById("ide-modal");
  if (modal) modal.style.display = 'none'; 
}

function downloadCode() { 
  if (!editor) return;
  
  const b = new Blob([editor.getValue()], {type:'text/plain'}); 
  const a = document.createElement('a'); 
  a.href = URL.createObjectURL(b); 
  a.download = `darkroot_code_${Date.now()}.${currentLang}`; 
  a.click(); 
  showGestureFeedback(`Code saved as ${a.download}`);
}

function switchTab(t) { 
  // Update tab buttons
  document.querySelectorAll('.mobile-tab').forEach(e => {
    if (e) e.classList.remove('active');
  });
  
  const tab = document.getElementById('tab-' + t);
  if (tab) tab.classList.add('active');
  
  // Show/hide panes
  const editorPane = document.getElementById('editor-pane');
  const previewPane = document.getElementById('preview-pane');
  
  if (editorPane) {
    if (t === 'editor') {
      editorPane.classList.add('active');
    } else {
      editorPane.classList.remove('active');
    }
  }
  
  if (previewPane) {
    if (t === 'preview') {
      previewPane.classList.add('active');
    } else {
      previewPane.classList.remove('active');
    }
  }
}

function changeFontSize(d) { 
  if (!editor) return;
  
  const currentSize = parseInt(editor.getFontSize());
  const newSize = Math.max(10, Math.min(24, currentSize + d));
  editor.setFontSize(newSize + "px"); 
}

// --- STUDY MODAL FUNCTIONS ---
function startHackingCourse(course) {
  const courses = {
    basics: "Ethical Hacking Fundamentals",
    networking: "Network Security & Protocols",
    web: "Web Application Security",
    cryptography: "Cryptography & Encryption",
    forensics: "Digital Forensics",
    tools: "Security Tools & Frameworks"
  };
  
  const courseName = courses[course] || "Legal Hacking";
  closeStudyModal();
  
  const message = `Starting course: **${courseName}**\n\nI'll guide you through legal and ethical aspects of ${courseName.toLowerCase()}. Remember:\n\n1. Always obtain proper authorization\n2. Follow legal guidelines\n3. Use skills for defense, not offense\n4. Respect privacy and data protection laws\n\nWhat specific aspect of ${courseName.toLowerCase()} would you like to learn about first?`;
  
  appendMessage(message, "ai");
  conversationHistory.push({ 
    role: "system", 
    content: `You are now teaching ${courseName}. Focus on legal, ethical hacking practices. Provide educational content about concepts, tools, and techniques that are legal to learn and practice. Emphasize defensive security, penetration testing with permission, and cybersecurity best practices. Do not provide instructions for illegal activities. Use DeepSeek AI capabilities for detailed technical explanations.`
  });
}

function activateDeepSeekAI() {
  const modelSelect = document.getElementById('model-select');
  if (modelSelect) modelSelect.value = 'deepseek/deepseek-chat';
  currentModel = 'deepseek/deepseek-chat';
  
  // Close any open modals
  closeStudyModal();
  closeIde();
  
  appendMessage(" **DeepSeek AI Activated**\n\nI'm now using DeepSeek V3 - a powerful AI model with enhanced capabilities for:\n\n Advanced coding and debugging\n Cybersecurity analysis\n Technical problem-solving\n Algorithm design and optimization\n System architecture planning\n\n*Note: DeepSeek AI provides superior performance for technical tasks with 128K context window support.*", "ai");
  
  conversationHistory.push({ 
    role: "system", 
    content: `You are DeepSeek AI, an advanced AI assistant powered by DarkRoot AI. Provide superior technical assistance with enhanced capabilities for:
    1. Complex coding and debugging
    2. Cybersecurity analysis and ethical hacking guidance
    3. Technical problem-solving with detailed explanations
    4. Algorithm design and optimization
    5. System architecture and planning
    
    Always emphasize:
     Legality and ethics in cybersecurity discussions
     Proper authorization requirements
     Defensive security practices
     Educational purposes only
     Compliance with laws and regulations
    
    Provide comprehensive, technical answers with practical examples and best practices.`
  });
  
  showGestureFeedback("DeepSeek AI Activated!");
}

// --- UTILITY FUNCTIONS ---
function toggleVoiceInput() {
  if(!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) { 
    alert("Speech recognition not supported in this browser"); 
    return; 
  }
  
  const btn = document.getElementById('mic-btn');
  if(!btn) return;
  
  if(btn.classList.contains('recording')) {
    if (currentRecognition) {
      currentRecognition.stop();
    }
    btn.classList.remove('recording');
    btn.innerHTML = '<i class="fas fa-microphone"></i>';
    return;
  }
  
  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  const recognition = new SpeechRecognition();
  currentRecognition = recognition;
  
  recognition.lang = 'en-US';
  recognition.interimResults = true;
  recognition.continuous = false;
  
  btn.classList.add('recording');
  btn.innerHTML = '<i class="fas fa-stop"></i>';
  
  recognition.onresult = (e) => {
    const transcript = Array.from(e.results)
      .map(result => result[0])
      .map(result => result.transcript)
      .join('');
    
    const userInput = document.getElementById('user-input');
    if (userInput) {
      userInput.value = transcript;
      userInput.focus();
      userInput.style.height = 'auto';
      userInput.style.height = (userInput.scrollHeight) + 'px';
    }
  };
  
  recognition.onerror = (e) => {
    console.error("Speech recognition error:", e.error);
    btn.classList.remove('recording');
    btn.innerHTML = '<i class="fas fa-microphone"></i>';
  };
  
  recognition.onend = () => {
    btn.classList.remove('recording');
    btn.innerHTML = '<i class="fas fa-microphone"></i>';
    currentRecognition = null;
    
    const userInput = document.getElementById('user-input');
    const text = userInput ? userInput.value.trim() : "";
    if (text && text.length > 2) {
      setTimeout(() => sendMessage(), 500);
    }
  };
  
  recognition.start();
}

function exportChat() {
  let chatText = "=== DarkRoot AI Chat Export ===\n";
  chatText += `Date: ${new Date().toLocaleString()}\n`;
  chatText += `Model: ${currentModel}\n`;
  chatText += "=".repeat(50) + "\n\n";
  
  conversationHistory.forEach(m => {
    if (m.role !== 'system') {
      const role = m.role === 'user' ? 'USER' : 'DARKROOT AI';
      chatText += `[${role}]:\n${m.content}\n\n`;
    }
  });
  
  const b = new Blob([chatText], {type:'text/plain'}); 
  const a = document.createElement('a'); 
  a.href = URL.createObjectURL(b); 
  a.download = `darkroot_chat_${Date.now()}.txt`; 
  a.click();
  showGestureFeedback("Chat exported successfully");
}

function clearContext() { 
  if (confirm("Clear all conversation history? This cannot be undone.")) {
    conversationHistory = [{role:"system",content:"You are DarkRoot AI, an advanced AI assistant for cybersecurity and coding."}];
    showGestureFeedback("Conversation cleared");
    appendMessage("Conversation context has been cleared. How can I help you?", "ai");
    window.saveCurrentSession();
  }
}

function changeModel() { 
  const modelSelect = document.getElementById('model-select');
  if (modelSelect) {
    currentModel = modelSelect.value; 
    if (currentModel === "deepseek/deepseek-chat") {
      showGestureFeedback("DeepSeek AI mode activated");
      appendMessage("Switched to DeepSeek V3 mode - Enhanced performance for technical tasks.", "ai");
    } else {
      showGestureFeedback(`Model changed to: ${currentModel.split('/').pop()}`);
      appendMessage(`Switched to ${currentModel.split('/').pop()} model.`, "ai");
    }
  }
}

// Auto-save code
setInterval(() => {
  if (editor && document.getElementById('ide-modal')?.style.display === 'flex') {
    localStorage.setItem('darkroot_last_code', editor.getValue());
    localStorage.setItem('darkroot_last_lang', currentLang);
  }
}, 30000);

// Initialize
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', initApp);
} else {
  initApp();
}
</script>
</body>
</html>